<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reembolsos No Deducibles - ACEROS CABOS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --adp-primary: #1a365d;
                --adp-secondary: #2d3748;
                --adp-accent: #3182ce;
                --adp-light: #f7fafc;
                --adp-gray: #718096;
                --adp-success: #38a169;
                --adp-warning: #ed8936;
                --adp-danger: #e53e3e;
                --adp-dark: #1e293b;
                --adp-info: #06b6d4;
                --adp-gradient: linear-gradient(135deg, #1a365d 0%, #2d3748 50%, #3182ce 100%);
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: var(--adp-gradient);
                min-height: 100vh;
                color: var(--adp-dark);
            }

            /* ESTILOS DE LOGIN */
            .login-container {
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                padding: 20px;
            }

            .login-card {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(15px);
                border-radius: 20px;
                padding: 40px;
                box-shadow: 0 25px 50px rgba(26, 54, 93, 0.2);
                width: 100%;
                max-width: 450px;
                text-align: center;
                border: 1px solid rgba(26, 54, 93, 0.1);
            }

            .login-logo {
                font-size: 3em;
                color: var(--adp-primary);
                margin-bottom: 20px;
            }

            .login-title {
                color: var(--adp-primary);
                font-size: 2em;
                margin-bottom: 30px;
                font-weight: 700;
            }

            /* APLICACIÓN PRINCIPAL */
            .app-container {
                display: none;
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
            }

            .header {
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(15px);
                border-radius: 20px;
                padding: 30px;
                margin-bottom: 30px;
                box-shadow: 0 15px 35px rgba(26, 54, 93, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
                border: 1px solid rgba(26, 54, 93, 0.05);
            }

            .header-info h1 {
                color: var(--adp-primary);
                font-size: 2.5em;
                margin-bottom: 10px;
                font-weight: 700;
            }

            .header-info p {
                color: var(--adp-gray);
                font-size: 1.2em;
            }

            .user-info {
                text-align: right;
            }

            .user-name {
                font-weight: 600;
                color: var(--adp-dark);
                margin-bottom: 5px;
            }

            .user-role {
                color: var(--adp-gray);
                font-size: 0.9em;
                margin-bottom: 10px;
            }

            .logout-btn {
                background: var(--adp-danger);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s ease;
            }

            .logout-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(229, 62, 62, 0.4);
            }

            .nav-tabs {
                display: flex;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 15px;
                padding: 10px;
                margin-bottom: 30px;
                box-shadow: 0 15px 35px rgba(26, 54, 93, 0.1);
                overflow-x: auto;
                border: 1px solid rgba(26, 54, 93, 0.05);
            }

            .nav-tab {
                flex: 1;
                min-width: 200px;
                padding: 15px 20px;
                text-align: center;
                background: transparent;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: 600;
                color: var(--adp-gray);
                white-space: nowrap;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .nav-tab:hover {
                background: rgba(26, 54, 93, 0.1);
                color: var(--adp-primary);
                transform: translateY(-2px);
            }

            .nav-tab.active {
                background: var(--adp-primary);
                color: white;
                box-shadow: 0 8px 25px rgba(26, 54, 93, 0.4);
            }

            .tab-content {
                display: none;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(15px);
                border-radius: 20px;
                padding: 30px;
                box-shadow: 0 15px 35px rgba(26, 54, 93, 0.1);
                animation: fadeIn 0.5s ease;
                border: 1px solid rgba(26, 54, 93, 0.05);
            }

            .tab-content.active {
                display: block;
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .form-group {
                margin-bottom: 25px;
            }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: var(--adp-primary);
            }

            .form-control {
                width: 100%;
                padding: 15px;
                border: 2px solid #e2e8f0;
                border-radius: 12px;
                font-size: 16px;
                transition: all 0.3s ease;
                background: white;
            }

            .form-control:focus {
                outline: none;
                border-color: var(--adp-accent);
                box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
                transform: translateY(-2px);
            }

            .btn {
                padding: 15px 30px;
                border: none;
                border-radius: 12px;
                cursor: pointer;
                font-weight: 600;
                font-size: 16px;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            }

            .btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            .btn-primary {
                background: var(--adp-primary);
                color: white;
            }

            .btn-primary:hover {
                background: var(--adp-secondary);
                box-shadow: 0 8px 25px rgba(26, 54, 93, 0.3);
            }

            .btn-success {
                background: var(--adp-success);
                color: white;
            }

            .btn-success:hover {
                box-shadow: 0 8px 25px rgba(56, 161, 105, 0.3);
            }

            .btn-danger {
                background: var(--adp-danger);
                color: white;
            }

            .btn-danger:hover {
                box-shadow: 0 8px 25px rgba(229, 62, 62, 0.3);
            }

            .btn-warning {
                background: var(--adp-warning);
                color: white;
            }

            .btn-warning:hover {
                box-shadow: 0 8px 25px rgba(237, 137, 54, 0.3);
            }

            .file-upload {
                border: 2px dashed #cbd5e0;
                border-radius: 12px;
                padding: 40px;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s ease;
                background: var(--adp-light);
            }

            .file-upload:hover {
                border-color: var(--adp-accent);
                background: rgba(49, 130, 206, 0.05);
            }

            .file-upload.dragover {
                border-color: var(--adp-primary);
                background: rgba(26, 54, 93, 0.1);
            }

            .reimbursement-card {
                background: white;
                border-radius: 15px;
                padding: 25px;
                margin-bottom: 20px;
                box-shadow: 0 15px 35px rgba(26, 54, 93, 0.1);
                transition: all 0.3s ease;
                border-left: 5px solid var(--adp-primary);
            }

            .reimbursement-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 40px rgba(26, 54, 93, 0.15);
            }

            .status-badge {
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .status-pendiente { 
                background: #fef5e7; 
                color: var(--adp-warning); 
            }

            .status-aprobado { 
                background: #f0fff4; 
                color: var(--adp-success); 
            }


            .status-solicitado_entrega { 
                background: #fff5e6; 
                color: var(--adp-warning); 
            }

            .status-entregado { 
                background: #f0fff4; 
                color: var(--adp-success); 
            }

            .status-rechazado { 
                background: #fed7d7; 
                color: var(--adp-danger); 
            }

            .status-en_corte { 
                background: #e6f3ff; 
                color: var(--adp-accent); 
            }

            .progress-bar {
                background: #e2e8f0;
                height: 8px;
                border-radius: 4px;
                overflow: hidden;
                margin: 15px 0;
            }

            .progress-fill {
                height: 100%;
                background: var(--adp-primary);
                border-radius: 4px;
                transition: width 0.5s ease;
            }

            .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: white;
                padding: 25px;
                border-radius: 15px;
                text-align: center;
                box-shadow: 0 15px 35px rgba(26, 54, 93, 0.1);
                transition: transform 0.3s ease;
                border: 1px solid rgba(26, 54, 93, 0.05);
            }

            .stat-card:hover {
                transform: translateY(-5px);
            }

            .stat-number {
                font-size: 2.5em;
                font-weight: 700;
                color: var(--adp-primary);
                margin-bottom: 10px;
            }

            .stat-label {
                color: var(--adp-gray);
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f3f3f3;
                border-top: 3px solid var(--adp-accent);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 15px 35px rgba(26, 54, 93, 0.2);
                z-index: 1001;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                border-left: 4px solid var(--adp-primary);
            }

            .notification.show {
                transform: translateX(0);
            }

            .notification.success {
                border-left-color: var(--adp-success);
            }

            .notification.error {
                border-left-color: var(--adp-danger);
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(26, 54, 93, 0.9);
                backdrop-filter: blur(5px);
                z-index: 1000;
                animation: modalFade 0.3s ease;
            }

            .modal.active {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                background: white;
                border-radius: 20px;
                padding: 30px;
                max-width: 800px;
                width: 90%;
                max-height: 90vh;
                overflow-y: auto;
                animation: modalSlide 0.3s ease;
                position: relative;
                border: 1px solid rgba(26, 54, 93, 0.1);
            }

            @keyframes modalSlide {
                from { transform: translateY(-50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }

            .close {
                position: absolute;
                top: 15px;
                right: 20px;
                font-size: 28px;
                cursor: pointer;
                color: var(--adp-gray);
                transition: color 0.3s ease;
            }

            .close:hover {
                color: var(--adp-danger);
            }

            .search-box {
                position: relative;
                margin-bottom: 20px;
            }

            .search-box input {
                padding-left: 45px;
            }

            .search-box i {
                position: absolute;
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
                color: var(--adp-gray);
            }

            .nombre-input {
                position: relative;
            }

            .suggestions-list {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
                box-shadow: 0 8px 25px rgba(26, 54, 93, 0.1);
            }

            .suggestion-item {
                padding: 10px 15px;
                cursor: pointer;
                transition: background 0.2s ease;
            }

            .suggestion-item:hover {
                background: var(--adp-light);
            }

            .autoriza-input, .concepto-input {
                position: relative;
            }

            .autoriza-input .suggestions-list,
            .concepto-input .suggestions-list {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #e2e8f0;
                border-top: none;
                border-radius: 0 0 8px 8px;
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
            }

            .add-new-option {
                padding: 10px;
                background: #e6fffa;
                color: #2d3748;
                font-weight: 600;
                border-bottom: 1px solid #68d391;
                cursor: pointer;
            }

            .add-new-option:hover {
                background: #b2f5ea;
            }



            .excel-upload {
                background: #e6fffa;
                border: 2px dashed var(--adp-success);
                border-radius: 12px;
                padding: 30px;
                text-align: center;
                margin-bottom: 20px;
            }

            /* ============================== */
            /* MOBILE RESPONSIVE - TABLETS   */
            /* ============================== */
            @media (max-width: 1024px) {
                .app-container {
                    padding: 15px;
                }

                .header {
                    padding: 20px;
                    margin-bottom: 20px;
                }

                .header-info h1 {
                    font-size: 1.8em;
                }

                .stats-grid {
                    grid-template-columns: repeat(2, 1fr);
                }

                .grid {
                    grid-template-columns: repeat(2, 1fr);
                }
            }

            /* ============================== */
            /* MOBILE RESPONSIVE - PHONES     */
            /* ============================== */
            @media (max-width: 768px) {
                /* === GENERAL === */
                body {
                    font-size: 14px;
                }

                .app-container {
                    padding: 10px;
                    max-width: 100%;
                }

                /* === HEADER === */
                .header {
                    flex-direction: column;
                    text-align: center;
                    padding: 15px;
                    margin-bottom: 15px;
                    border-radius: 15px;
                    gap: 12px;
                }

                .header-info h1 {
                    font-size: 1.3em;
                    line-height: 1.3;
                }

                .header-info p {
                    font-size: 0.9em;
                }

                .user-info {
                    text-align: center;
                    margin-top: 5px;
                    display: flex;
                    flex-wrap: wrap;
                    justify-content: center;
                    align-items: center;
                    gap: 8px;
                }

                .user-name, .user-role {
                    width: 100%;
                    margin-bottom: 2px;
                }

                .logout-btn {
                    padding: 10px 20px;
                    font-size: 13px;
                }

                /* === NAVIGATION TABS === */
                .nav-tabs {
                    flex-direction: row;
                    flex-wrap: nowrap;
                    overflow-x: auto;
                    -webkit-overflow-scrolling: touch;
                    scrollbar-width: none;
                    padding: 6px;
                    margin-bottom: 15px;
                    gap: 4px;
                    border-radius: 12px;
                }

                .nav-tabs::-webkit-scrollbar {
                    display: none;
                }

                .nav-tab {
                    min-width: auto;
                    padding: 10px 14px;
                    font-size: 12px;
                    border-radius: 8px;
                    white-space: nowrap;
                    flex: 0 0 auto;
                }

                .nav-tab i {
                    margin-right: 4px;
                }

                /* === TAB CONTENT === */
                .tab-content {
                    padding: 15px;
                    border-radius: 15px;
                }

                .tab-content h2 {
                    font-size: 1.3em;
                    margin-bottom: 5px;
                }

                /* === FORMS === */
                .grid {
                    grid-template-columns: 1fr !important;
                    gap: 12px;
                }

                .form-group {
                    margin-bottom: 15px;
                }

                .form-group label {
                    font-size: 13px;
                    margin-bottom: 6px;
                }

                .form-control {
                    padding: 12px;
                    font-size: 16px !important;
                    border-radius: 10px;
                }

                select.form-control {
                    font-size: 16px !important;
                    padding: 12px;
                    -webkit-appearance: none;
                    appearance: none;
                    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23718096' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
                    background-repeat: no-repeat;
                    background-position: right 12px center;
                    padding-right: 36px;
                }

                input[type="datetime-local"],
                input[type="date"] {
                    font-size: 16px !important;
                }

                /* === FILE UPLOAD === */
                .file-upload {
                    padding: 25px 15px;
                    border-radius: 10px;
                }

                .file-upload .fa-3x {
                    font-size: 2em !important;
                    margin-bottom: 10px !important;
                }

                .file-upload p {
                    font-size: 13px;
                }

                /* === BUTTONS === */
                .btn {
                    padding: 12px 20px;
                    font-size: 14px;
                    border-radius: 10px;
                    min-height: 44px;
                    touch-action: manipulation;
                }

                .btn:hover {
                    transform: none;
                }

                /* Stack buttons on mobile */
                div[style*="text-align: right"] {
                    text-align: center !important;
                }

                div[style*="margin-bottom: 20px"] > .btn {
                    width: 100%;
                    margin-bottom: 8px;
                    justify-content: center;
                }

                /* === REIMBURSEMENT CARDS === */
                .reimbursement-card {
                    padding: 15px;
                    border-radius: 12px;
                    margin-bottom: 12px;
                }

                .reimbursement-card:hover {
                    transform: none;
                }

                /* === STATUS BADGES === */
                .status-badge {
                    padding: 6px 12px;
                    font-size: 11px;
                }

                /* === STATS === */
                .stats-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                    margin-bottom: 20px;
                }

                .stat-card {
                    padding: 15px;
                    border-radius: 12px;
                }

                .stat-number {
                    font-size: 1.6em;
                }

                .stat-label {
                    font-size: 11px;
                }

                /* === TABLES - Horizontal scroll wrapper === */
                div[style*="overflow-x: auto"],
                div[style*="overflow-x:auto"] {
                    -webkit-overflow-scrolling: touch;
                }

                table {
                    font-size: 12px;
                }

                table th, table td {
                    padding: 8px 6px !important;
                    font-size: 12px;
                    white-space: nowrap;
                }

                /* === MODAL === */
                .modal-content {
                    width: 95%;
                    max-width: 95vw;
                    max-height: 95vh;
                    padding: 20px 15px;
                    border-radius: 15px;
                    margin: 10px;
                }

                .close {
                    top: 10px;
                    right: 15px;
                    font-size: 24px;
                    padding: 5px;
                    z-index: 10;
                }

                /* === LOGIN === */
                .login-card {
                    padding: 25px 20px;
                    border-radius: 15px;
                    max-width: 100%;
                    margin: 10px;
                }

                .login-logo {
                    font-size: 2.2em;
                    margin-bottom: 15px;
                }

                .login-title {
                    font-size: 1.5em;
                    margin-bottom: 20px;
                }

                /* === NOTIFICATIONS === */
                .notification {
                    top: 10px;
                    right: 10px;
                    left: 10px;
                    transform: translateY(-100px);
                    max-width: calc(100vw - 20px);
                }

                .notification.show {
                    transform: translateY(0);
                }

                /* === SEARCH BOX === */
                .search-box {
                    margin-bottom: 15px;
                }

                .search-box input {
                    font-size: 16px !important;
                }

                /* === SUGGESTIONS LIST === */
                .suggestions-list {
                    max-height: 180px;
                }

                .suggestion-item {
                    padding: 12px 15px;
                    font-size: 14px;
                }

                /* === EXCEL UPLOAD === */
                .excel-upload {
                    padding: 20px 15px;
                }

                /* === PROGRESS BAR === */
                .progress-bar {
                    margin: 10px 0;
                }

                /* === Inline form sections === */
                div[style*="background: white"][style*="border-radius: 15px"][style*="padding: 25px"] {
                    padding: 15px !important;
                    border-radius: 12px !important;
                }

                /* === Fix inline styles that break on mobile === */
                div[style*="display: flex"][style*="gap"] {
                    flex-wrap: wrap;
                }

                div[style*="display: flex"][style*="justify-content: space-between"] {
                    flex-wrap: wrap;
                    gap: 8px;
                }

                /* Make action buttons in cards stack properly */
                div[style*="display: flex"][style*="gap: 10px"] {
                    flex-wrap: wrap;
                }

                div[style*="display: flex"][style*="gap: 10px"] .btn {
                    flex: 1 1 auto;
                    min-width: 120px;
                    justify-content: center;
                    font-size: 12px;
                    padding: 10px 12px;
                }
            }

            /* ============================== */
            /* MOBILE RESPONSIVE - SMALL      */
            /* ============================== */
            @media (max-width: 480px) {
                .app-container {
                    padding: 6px;
                }

                .header {
                    padding: 12px;
                    border-radius: 12px;
                }

                .header-info h1 {
                    font-size: 1.1em;
                }

                .nav-tab {
                    padding: 8px 10px;
                    font-size: 11px;
                }

                .tab-content {
                    padding: 12px;
                    border-radius: 12px;
                }

                .tab-content h2 {
                    font-size: 1.1em;
                }

                .stats-grid {
                    grid-template-columns: 1fr 1fr;
                    gap: 8px;
                }

                .stat-card {
                    padding: 12px 8px;
                }

                .stat-number {
                    font-size: 1.3em;
                }

                .stat-label {
                    font-size: 10px;
                }

                .modal-content {
                    width: 100%;
                    max-width: 100vw;
                    max-height: 100vh;
                    border-radius: 0;
                    margin: 0;
                    padding: 15px 10px;
                }

                .reimbursement-card {
                    padding: 12px;
                    border-radius: 10px;
                }

                .btn {
                    padding: 10px 16px;
                    font-size: 13px;
                }

                .form-control {
                    padding: 10px;
                }

                /* Full width buttons on very small screens */
                .btn-primary, .btn-success, .btn-danger, .btn-warning {
                    width: 100%;
                    justify-content: center;
                    margin-bottom: 6px;
                }
            }
    </style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <h1 class="login-title">ACEROS CABOS</h1>
            <h2 style="color: #718096; margin-bottom: 30px;">Reembolsos No Deducibles</h2>
            
            <form id="loginForm" autocomplete="on">
                <div class="form-group">
                    <input type="email" class="form-control" id="loginEmail" name="email" placeholder="Correo electrónico" autocomplete="email" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-control" id="loginPassword" name="password" placeholder="Contraseña" autocomplete="current-password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                </button>
            </form>
            
            <div id="loginError" style="color: #e53e3e; margin-top: 15px; display: none;"></div>
        </div>
    </div>

    <!-- APLICACIÓN PRINCIPAL -->
    <div id="mainApp" class="app-container">
        <div class="header">
            <div class="header-info">
                <h1><i class="fas fa-money-bill-wave"></i> Reembolsos No Deducibles</h1>
                <p>ACEROS CABOS - Gestión de Reembolsos</p>
            </div>
                <div class="user-info">
                    <div class="user-name" id="userName"></div>
                    <div class="user-role" id="userRole"></div>
                    <button class="btn btn-primary" onclick="recargarDatosCompletos()" style="margin-right: 10px; padding: 8px 16px; font-size: 14px;">
                        <i class="fas fa-sync"></i> Actualizar
                    </button>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                    </button>
                </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('nuevo-reembolso')" data-role="caja_chica,admin">
                <i class="fas fa-plus"></i> Nuevo Reembolso
            </button>
            <button class="nav-tab" onclick="showTab('revision')" data-role="admin,caja_chica">
                <i class="fas fa-search"></i> Revisión
            </button>
            <button class="nav-tab" onclick="showTab('entregas')" data-role="admin">
                <i class="fas fa-hand-holding-usd"></i> Entregas
            </button>
            <button class="nav-tab" onclick="showTab('reportes')" data-role="admin,caja_chica">
                <i class="fas fa-chart-bar"></i> Reportes
            </button>
            <button class="nav-tab" onclick="showTab('dashboard')" data-role="admin">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
        </div>

        <!-- Nuevo Reembolso Tab -->
        <div id="nuevo-reembolso" class="tab-content active">
            <h2><i class="fas fa-file-invoice-dollar"></i> Nuevo Reembolso</h2>
            <p style="color: #718096; margin-bottom: 30px;">Registra un nuevo reembolso no deducible</p>
            
            <!-- Formulario Individual -->
            <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-user"></i> Reembolso Individual</h3>
                
                <div class="grid">  
                    <div class="form-group">
                        <label>Nombre del Beneficiario *</label>
                        <div class="nombre-input">
                            <input type="text" class="form-control" id="nombreBeneficiario" 
                                placeholder="Escribe el nombre..." required autocomplete="off">
                            <div id="suggestionsList" class="suggestions-list"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="datetime-local" class="form-control" id="fechaReembolso" required>
                    </div>
                    <div class="form-group">
                        <label>Monto *</label>
                        <input type="number" class="form-control" id="montoReembolso" 
                            placeholder="0.00" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Quien Autoriza *</label>
                        <select class="form-control" id="quienAutoriza" required>
                            <option value="">-- Seleccione quien autoriza --</option>
                            <option value="Alejandra Zepeda">Alejandra Zepeda</option>
                            <option value="Andrés Salazar">Andrés Salazar</option>
                            <option value="Cristina Valadez">Cristina Valadez</option>
                            <option value="David Ramírez">David Ramírez</option>
                            <option value="Diana Gpe. Rivera Ortega">Diana Gpe. Rivera Ortega</option>
                            <option value="Flor Santos">Flor Santos</option>
                            <option value="Francisco Armenta">Francisco Armenta</option>
                            <option value="Gisela Armenta">Gisela Armenta</option>
                            <option value="Gmo. Tostado">Gmo. Tostado</option>
                            <option value="Guillermo Corrales Cruz">Guillermo Corrales Cruz</option>
                            <option value="Hugo Andrés Salazar Osorio">Hugo Andrés Salazar Osorio</option>
                            <option value="Ing Javier Pinedo">Ing Javier Pinedo</option>
                            <option value="Jasive Trasviña">Jasive Trasviña</option>
                            <option value="José Urías">José Urías</option>
                            <option value="Karla Ochoa">Karla Ochoa</option>
                            <option value="Lic Ana Maria">Lic Ana Maria</option>
                            <option value="Lic Diana Soto">Lic Diana Soto</option>
                            <option value="Lic Fernando Balderrama">Lic Fernando Balderrama</option>
                            <option value="Lic Fernando Olais">Lic Fernando Olais</option>
                            <option value="Lic Jose Balderrama">Lic Jose Balderrama</option>
                            <option value="Luis Adrian Monroy Torres">Luis Adrian Monroy Torres</option>
                            <option value="Rosa María De Balderrama">Rosa María De Balderrama</option>
                            <option value="Felipe Reyes Cota">Felipe Reyes Cota</option>
                            <option value="Victor Hugo Diaz Navarro">Victor Hugo Diaz Navarro</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Concepto *</label>
                    <select class="form-control" id="conceptoReembolso" required style="padding: 10px; font-size: 14px;">
                        <option value="">Selecciona un concepto...</option>
                        <option value="ANUNCIOS EN PESEROS">ANUNCIOS EN PESEROS</option>
                        <option value="ARRENDAMIENTOS">ARRENDAMIENTOS</option>
                        <option value="CARGA Y DESCARGA">CARGA Y DESCARGA</option>
                        <option value="CASA LIC FBV Y JBV">CASA LIC FBV Y JBV</option>
                        <option value="COMIDAS">COMIDAS</option>
                        <option value="COMISIONES">COMISIONES</option>
                        <option value="COMPENSACIONES">COMPENSACIONES</option>
                        <option value="COMPRAS">COMPRAS</option>
                        <option value="DIVERSOS">DIVERSOS</option>
                        <option value="DUPLICADOS DE LLAVES">DUPLICADOS DE LLAVES</option>
                        <option value="EQ. DE COMPUTO">EQ. DE COMPUTO</option>
                        <option value="ESTACIONAMIENTO">ESTACIONAMIENTO</option>
                        <option value="GAS">GAS</option>
                        <option value="GASTOS DIRECTIVOS">GASTOS DIRECTIVOS</option>
                        <option value="GUARDIA NACIONAL">GUARDIA NACIONAL</option>
                        <option value="HORAS EXTRAS">HORAS EXTRAS</option>
                        <option value="LA MARIPOSA">LA MARIPOSA</option>
                        <option value="LAVANDERIA">LAVANDERIA</option>
                        <option value="LIMPIEZA">LIMPIEZA</option>
                        <option value="MANTTO EQ. DE TRANSP.">MANTTO EQ. DE TRANSP.</option>
                        <option value="MODALIDAD 40">MODALIDAD 40</option>
                        <option value="MUNICIPIO">MUNICIPIO</option>
                        <option value="PAPELERIA">PAPELERIA</option>
                        <option value="PREVISION SOCIAL">PREVISION SOCIAL</option>
                        <option value="PUBLICIDAD">PUBLICIDAD</option>
                        <option value="RENTA TRAB FORANEOS">RENTA TRAB FORANEOS</option>
                        <option value="SUELDOS">SUELDOS</option>
                        <option value="TRABAJOS DE HERRERIA">TRABAJOS DE HERRERIA</option>
                        <option value="TRANSITO LOCAL">TRANSITO LOCAL</option>
                        <option value="VIATICOS">VIATICOS</option>
                        <option value="VIAJE DE MATERIAL FORANEO">VIAJE DE MATERIAL FORANEO</option>
                        <option value="VIGILANCIA NOCTURNA">VIGILANCIA NOCTURNA</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Archivos Adjuntos *</label>
                    <div class="file-upload" onclick="document.getElementById('archivosReembolso').click()">
                        <i class="fas fa-cloud-upload-alt fa-3x" style="color: #667eea; margin-bottom: 15px;"></i>
                        <p>Haz clic aquí o arrastra los archivos</p>
                        <p style="font-size: 14px; color: #718096;">PDF, JPG, PNG, Excel (Max: 10MB c/u)</p>
                    </div>
                    <input type="file" id="archivosReembolso" multiple 
                        accept=".pdf,.jpg,.jpeg,.png,.xls,.xlsx" style="display: none;">
                    <div id="archivos-lista"></div>
                </div>
                
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-success" onclick="registrarReembolso()">
                        <i class="fas fa-save"></i> Registrar Reembolso
                    </button>
                </div>
            </div>

            <!-- Carga Masiva desde Excel 
            <div class="excel-upload">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-file-excel"></i> Carga Masiva desde Excel</h3>
                <p style="margin-bottom: 20px;">Sube un archivo Excel con múltiples reembolsos</p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="descargarPlantillaExcel()">
                        <i class="fas fa-download"></i> Descargar Plantilla
                    </button>
                </div>
                
                <input type="file" id="excelMasivo" accept=".xls,.xlsx" style="display: none;">
                <button class="btn btn-success" onclick="document.getElementById('excelMasivo').click()">
                    <i class="fas fa-upload"></i> Subir Excel
                </button>
                
                <div id="preview-excel" style="margin-top: 20px; display: none;"></div>
            </div> -->
        </div>

        <!-- Revisión Tab -->
        <div id="revision" class="tab-content">
            <h2><i class="fas fa-clipboard-check"></i> Revisión de Reembolsos</h2>
            
            <div class="search-box">
                <input type="text" class="form-control" placeholder="Buscar reembolsos..." id="searchRevision">
                <i class="fas fa-search"></i>
            </div>

            <div id="reembolsos-revision">
                <div class="loading" style="margin: 40px auto;"></div>
            </div>
        </div>

        <!-- Nueva sección Entregas -->
        <div id="entregas" class="tab-content">
            <h2>
                <i class="fas fa-hand-holding-usd"></i> Gestión de Entregas
            </h2>
            <p style="color: #718096; margin-bottom: 30px;">
                Control de solicitudes y entregas de dinero
            </p>
            <div id="contenido-entregas">
                <div class="loading" style="margin: 40px auto;"></div>
            </div>
        </div>



        <!-- Reportes Tab -->
        <div id="reportes" class="tab-content">
            <h2><i class="fas fa-file-alt"></i> Reportes y Consultas</h2>
            
            <div class="grid" style="margin-bottom: 30px;">
                <div class="form-group">
                    <label>Fecha Desde</label>
                    <input type="date" class="form-control" id="fechaDesde">
                </div>
                <div class="form-group">
                    <label>Fecha Hasta</label>
                    <input type="date" class="form-control" id="fechaHasta">
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select class="form-control" id="filtroEstado">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="aprobado">Aprobado</option>
                        <option value="solicitado_entrega">Solicitado Entrega</option>
                        <option value="entregado">Entregado</option>
                        <option value="en_corte">En Corte</option>
                        <option value="rechazado">Rechazado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Beneficiario</label>
                    <input type="text" class="form-control" id="filtroBeneficiario" 
                        placeholder="Nombre del beneficiario">
                </div>
                <div class="form-group">
                    <label>Sucursal</label>
                    <select class="form-control" id="filtroSucursal">
                        <option value="">Todas las sucursales</option>
                        <option value="LMM">Los Mochis (LMM)</option>
                        <option value="JJR">Juan José Ríos (JJR)</option>
                        <option value="CLN">Culiacán (CLN)</option>
                        <option value="FTE">El Fuerte (FTE)</option>
                        <option value="SJC">San José del Cabo (SJC)</option>
                        <option value="CSL">Cabo San Lucas (CSL)</option>
                        <option value="TML">Tamaral (TML)</option>
                        <option value="LPZ">La Paz (LPZ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quien Entrega</label>
                    <select class="form-control" id="filtroQuienEntrega">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Lote</label>
                    <input type="text" class="form-control" id="filtroLote"
                        placeholder="Ej: 125-ICEL">
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="generarReporte()">
                    <i class="fas fa-search"></i> Consultar
                </button>
                <button class="btn btn-success" onclick="exportarExcel()">
                    <i class="fas fa-file-excel"></i> Exportar Excel
                </button>
            </div>

            <div id="tablaReportes">
                <div class="loading" style="margin: 40px auto;"></div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
            <p style="color: #718096; margin-bottom: 30px;">Vista general del sistema</p>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalReembolsos">0</div>
                    <div class="stat-label">Total Reembolsos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="montoTotal">$0</div>
                    <div class="stat-label">Monto Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendientesRevision">0</div>
                    <div class="stat-label">Pendientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="entregadosHoy">0</div>
                    <div class="stat-label">Entregados Hoy</div>
                </div>
            </div>
            
            <div id="actividad-reciente">
                <div class="loading" style="margin: 20px auto;"></div>
            </div>
        </div>
    </div>

    <!-- Modal para detalles -->
    <div id="modalReembolso" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <div id="contenidoModal"></div>
        </div>
    </div>

    <!-- Notificación -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <script>
    (function() {
        'use strict';

        // ✅ Prevenir ejecución múltiple del script - CRÍTICO para móviles
        if (window.appYaInicializada) {
            console.warn('⚠️ Script ya inicializado, deteniendo ejecución');
            return; // ← DETENER AQUÍ
        }
        window.appYaInicializada = true;

        // CONFIGURACIÓN
        // ✅ CONFIGURACIÓN SUPABASE CORRECTA
        const SUPABASE_URL = 'https://uqncsqstpcynjxnjhrqu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxbmNzcXN0cGN5bmp4bmpocnF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3ODE2NTgsImV4cCI6MjA3NTM1NzY1OH0.1LdLVHoMSVj7VmNy3DPUQRWjHpSBUQW5Bg0PtqJH0x8';

        // Inicialización definitiva y robusta
        let supabase;
        let currentUser = null;
        let reembolsos = [];
        let empleados = [];
        let autorizadores = [];
        let conceptosFrecuentes = [];
        let loginEnProceso = false;
        let reembolsosFiltradosGlobal = [];
        async function inicializarSistema() {
            if (!window.supabase) {
                setTimeout(inicializarSistema, 100);
                return;
            }

            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            window.supabaseInstance = supabase; // Guardar referencia global

            // Cargar usuario guardado
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                try {
                    console.log('🔄 Recuperando sesión guardada...');
                    currentUser = JSON.parse(storedUser);
                    // Normalizar el rol por si viene de una versión anterior
                    if (currentUser.rol) {
                        currentUser.rol = currentUser.rol.trim().toLowerCase();
                    }
                    console.log('👤 Sesión recuperada:', currentUser.email, currentUser.rol);
                    mostrarApp();
                    await inicializarDatos();
                } catch (error) {
                    console.error('❌ Error recuperando sesión:', error);
                    localStorage.removeItem('currentUser');
                    mostrarLogin();
                }
            } else {
                console.log('📝 No hay sesión guardada, mostrando login');
                mostrarLogin();
            }
        }

        async function inicializarDatos() {
            try {
                console.log('📦 Inicializando datos...');

                await cargarEmpleados();
                cargarAutorizadoresYConceptos();
                // setupAutocompletadoAutoriza(); // Ya no se usa - ahora es un select con lista fija
                setupAutocompletadoConcepto();
                await cargarDatos();
                setupAutocompletado();

                // Configurar permisos después de cargar datos
                if (currentUser) {
                    configurarPermisos();
                }

                // Agregar listeners para los filtros de reportes
                configurarListenersFiltros();

                // Configurar fecha máxima permitida en el campo de fecha
                configurarFechaMaxima();

                console.log('✅ Datos inicializados correctamente');
            } catch (error) {
                console.error('⚠️ Error en inicializarDatos (no crítico):', error);
                // No propagamos el error para que no cause logout
                // La app puede funcionar con datos parciales
            }
        }

        function configurarFechaMaxima() {
            const campoFecha = document.getElementById('fechaReembolso');
            if (campoFecha) {
                const maxFecha = new Date();
                maxFecha.setDate(maxFecha.getDate() + 1);
                maxFecha.setMinutes(maxFecha.getMinutes() - maxFecha.getTimezoneOffset());
                campoFecha.max = maxFecha.toISOString().slice(0, 16);
            }
        }

        function configurarListenersFiltros() {
            const filtros = ['fechaDesde', 'fechaHasta', 'filtroEstado', 'filtroBeneficiario', 'filtroSucursal', 'filtroQuienEntrega', 'filtroLote'];

            filtros.forEach(filtroId => {
                const elemento = document.getElementById(filtroId);
                if (elemento) {
                    elemento.addEventListener('change', generarReporte);
                    elemento.addEventListener('input', generarReporte);
                }
            });
        }

        // Función helper para generar IDs seguros para lotes
        function sanitizarIdLote(numeroLote) {
            return 'lote_' + numeroLote.replace(/[^a-zA-Z0-9]/g, '_');
        }

        // Iniciar cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializarSistema);
        } else {
            inicializarSistema();
        }

        // AGREGAR ESTA FUNCIÓN AL INICIO DEL JAVASCRIPT
        function filtrarReembolsosPorUsuario(reembolsosList) {
            // Admin y administracion ven todo, otros usuarios solo ven sus propios reembolsos
            if (currentUser && (currentUser.rol === 'admin' || currentUser.rol === 'administracion')) {
                return reembolsosList;
            } else if (currentUser && currentUser.email) {
                return reembolsosList.filter(r => r.usuario_registro === currentUser.email); // ✅ CORREGIDO: usuario_registro
            } else {
                return [];
            }
        }
        // ✅ FUNCIÓN LOGIN CORREGIDA
        async function login(e) {
            e.preventDefault();

            // ✅ PROTECCIÓN: Prevenir múltiples envíos (problema común en móviles)
            if (loginEnProceso) {
                console.log('⚠️ Login ya en proceso, ignorando envío duplicado');
                return;
            }

            loginEnProceso = true;

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim(); // ✅ CRÍTICO: trim() para evitar espacios en móviles
            const loginError = document.getElementById('loginError');
            const submitButton = e.target.querySelector('button[type="submit"]');

            loginError.style.display = 'none';

            // Deshabilitar botón mientras se procesa
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando...';
            }

            console.log('🔐 Intentando login con:', email);

            try {
                // ✅ VOLVER A LA TABLA RND_USUARIOS
                const { data: usuarios, error } = await supabase
                    .from('rnd_usuarios')  // ← Tabla correcta del sistema RND
                    .select('*');
                
                console.log('👥 Usuarios RND obtenidos:', usuarios);
                
                if (error) {
                    throw new Error('Error de conexión: ' + error.message);
                }
                
                if (!usuarios || usuarios.length === 0) {
                    throw new Error('No hay usuarios en rnd_usuarios. Hay que insertarlos.');
                }
                
                // Buscar el usuario en la tabla RND
                console.log('🔍 Buscando usuario con email:', email);
                console.log('🔍 Password length:', password.length);

                const usuario = usuarios.find(u => {
                    const emailMatch = u.email === email;
                    const passwordMatch = u.password === password;
                    const activoMatch = u.activo === true;

                    console.log(`👤 Usuario: ${u.email} (${u.rol})`);
                    console.log(`  ✉️  Email match: ${emailMatch} (BD: "${u.email}" vs Input: "${email}")`);
                    console.log(`  🔑 Password match: ${passwordMatch} (lengths: BD=${u.password ? u.password.length : 0} vs Input=${password.length})`);
                    console.log(`  ✅ Activo: ${activoMatch} (BD: ${u.activo})`);

                    if (emailMatch && !passwordMatch) {
                        console.warn(`⚠️ Email correcto pero password INCORRECTO para ${u.email}`);
                        console.warn(`   Password BD: "${u.password}"`);
                        console.warn(`   Password Input: "${password}"`);
                    }

                    return emailMatch && passwordMatch && activoMatch;
                });
                
                if (!usuario) {
                    // Verificar si el email existe pero la contraseña es incorrecta
                    const usuarioExiste = usuarios.find(u => u.email === email);
                    if (usuarioExiste) {
                        if (!usuarioExiste.activo) {
                            throw new Error('Tu cuenta está desactivada. Contacta al administrador.');
                        }
                        throw new Error('Contraseña incorrecta. Verifica e intenta de nuevo.');
                    }
                    throw new Error('Usuario no encontrado. Verifica tu correo electrónico.');
                }
                
                console.log('✅ Login exitoso:', usuario.nombre);

                currentUser = {
                    email: usuario.email.trim(),
                    nombre: usuario.nombre.trim(),
                    rol: usuario.rol.trim().toLowerCase(),
                    sucursal: usuario.sucursal ? usuario.sucursal.trim() : ''
                };

                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                console.log('👤 Usuario configurado:', currentUser);
                console.log('🔑 Rol normalizado:', currentUser.rol);

                mostrarApp();

                // Cargar datos de forma segura sin bloquear el login
                try {
                    await cargarDatos();
                } catch (error) {
                    console.error('⚠️ Error cargando datos (no crítico):', error);
                    // No mostramos error al usuario, la app ya se mostró
                }

            } catch (error) {
                console.error('❌ Error en login:', error);
                loginError.textContent = error.message;
                loginError.style.display = 'block';

                // Restaurar botón en caso de error
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesión';
                }
            } finally {
                // ✅ Siempre liberar el lock, incluso si hubo error
                loginEnProceso = false;
            }
        }

        // AGREGAR función de logout
        async function logout() {
            await supabase.auth.signOut();
            localStorage.removeItem('currentUser');
            currentUser = null;
            mostrarLogin();
        }

        // AGREGAR esta función nueva
        async function inicializarSistemaRND() {
            // Verificar si hay sesión activa
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                // Hay sesión, verificar usuario en RND
                try {
                    const { data: userData, error } = await supabase
                        .from('rnd_usuarios')
                        .select('*')
                        .eq('email', session.user.email)
                        .eq('activo', true)
                        .single();
                    
                    if (!error && userData) {
                        currentUser = {
                            email: userData.email,
                            nombre: userData.nombre,
                            rol: userData.rol,
                            sucursal: userData.sucursal
                        };
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        mostrarApp();
                        await cargarDatos();
                        return;
                    }
                } catch (error) {
                    console.log('Usuario no encontrado en RND');
                }
            }
            
            // No hay sesión válida, mostrar login
            mostrarLogin();
        }


        function verificarSesion() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                mostrarApp();
                cargarDatos();
            }
        }

        function mostrarLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            
            // Buscar el contenedor principal (puede tener diferentes IDs)
            const mainApp = document.getElementById('appContainer') || 
                        document.getElementById('mainApp') || 
                        document.querySelector('.app-container');
            
            if (mainApp) {
                mainApp.style.display = 'none';
            }
            
            console.log('✅ Login mostrado');
        }

        function mostrarApp() {
            document.getElementById('loginScreen').style.display = 'none';
            
            const mainApp = document.getElementById('appContainer') || 
                        document.getElementById('mainApp') || 
                        document.querySelector('.app-container');
            
            if (mainApp) {
                mainApp.style.display = 'block';
            }
            
            // Actualizar información del usuario
            if (currentUser) {
                const userNameElement = document.getElementById('userName');
                const userRoleElement = document.getElementById('userRole');
                
                if (userNameElement) userNameElement.textContent = currentUser.nombre;
                if (userRoleElement) userRoleElement.textContent = currentUser.rol.toUpperCase();
                
                // Configurar permisos de tabs
                configurarPermisos();
                
                // Actualizar header con sucursal
                actualizarHeaderConSucursal();
            }
            
            console.log('✅ Aplicación mostrada');
        }

        function mostrarNotificacion(mensaje, tipo) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            if (notification && notificationText) {
                notificationText.textContent = mensaje;
                notification.className = `notification ${tipo}`;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 4000);
            } else {
                alert(mensaje); // Fallback
            }
        }



        function actualizarHeaderConSucursal() {
            const headerInfo = document.querySelector('.header-info p');
            if (headerInfo && currentUser.sucursal) {
                const nombresSucursales = {
                    'LMM': 'Los Mochis',
                    'JJR': 'Juan José Ríos', 
                    'CLN': 'Culiacán',
                    'FTE': 'El Fuerte',
                    'SJC': 'San José del Cabo',
                    'CSL': 'Cabo San Lucas',
                    'TML': 'Tamaral',
                    'LPZ': 'La Paz'
                };
                
                const nombreSucursal = nombresSucursales[currentUser.sucursal] || currentUser.sucursal;
                headerInfo.textContent = `ACEROS CABOS - Gestión de Reembolsos - Sucursal ${nombreSucursal}`;
            }
        }


        function configurarPermisos() {
            console.log('=== CONFIGURANDO PERMISOS ===');
            console.log('Usuario actual:', currentUser);

            if (!currentUser || !currentUser.rol) {
                console.error('❌ Error: currentUser o currentUser.rol no está definido');
                return;
            }

            console.log('Rol del usuario:', currentUser.rol);

            const tabs = document.querySelectorAll('.nav-tab');
            let primerTabVisible = null;

            tabs.forEach(tab => {
                const rolesPermitidos = tab.getAttribute('data-role').split(',').map(r => r.trim().toLowerCase());
                const textoTab = tab.textContent.trim();
                const rolUsuario = currentUser.rol.trim().toLowerCase();

                console.log(`Tab "${textoTab}":`, rolesPermitidos);
                console.log(`¿Incluye rol ${rolUsuario}?`, rolesPermitidos.includes(rolUsuario));

                if (rolesPermitidos.includes(rolUsuario)) {
                    tab.style.display = 'flex';
                    console.log(`✅ Mostrando tab: ${textoTab}`);

                    // Guardar el primer tab visible para activarlo
                    if (!primerTabVisible) {
                        primerTabVisible = tab;
                    }
                } else {
                    tab.style.display = 'none';
                    console.log(`❌ Ocultando tab: ${textoTab}`);

                    // Si este tab estaba activo, remover la clase active
                    if (tab.classList.contains('active')) {
                        tab.classList.remove('active');
                    }
                }
            });
            
            // Activar el primer tab visible si ninguno está activo
            const tabActivo = document.querySelector('.nav-tab.active:not([style*="display: none"])');
            if (!tabActivo && primerTabVisible) {
                console.log('Activando primer tab visible:', primerTabVisible.textContent.trim());
                
                // Remover active de todos los tabs
                tabs.forEach(t => t.classList.remove('active'));
                
                // Activar el primer tab visible
                primerTabVisible.classList.add('active');
                
                // Mostrar el contenido correspondiente
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Determinar qué contenido mostrar basado en el tab
                const tabText = primerTabVisible.textContent.trim();
                let targetTabId = 'nuevo-reembolso'; // default
                
                if (tabText.includes('Nuevo Reembolso')) targetTabId = 'nuevo-reembolso';
                else if (tabText.includes('Revisión')) targetTabId = 'revision';
                else if (tabText.includes('Entregas')) targetTabId = 'entregas';
                else if (tabText.includes('Reportes')) targetTabId = 'reportes';
                else if (tabText.includes('Dashboard')) targetTabId = 'dashboard';
                
                const targetContent = document.getElementById(targetTabId);
                if (targetContent) {
                    targetContent.classList.add('active');
                }
            }
        }

        // CARGA DE DATOS
        // ✅ FUNCIÓN CARGAR DATOS COMPLETA
        async function cargarDatos() {
            try {
                console.log('📊 Cargando datos...');

                // Paginación para superar el límite de 1000 registros de Supabase
                let todosLosReembolsos = [];
                let desde = 0;
                const tamañoPagina = 1000;
                let hayMas = true;

                while (hayMas) {
                    const { data, error } = await supabase
                        .from('rnd_reembolsos')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .range(desde, desde + tamañoPagina - 1);

                    if (error) throw error;

                    todosLosReembolsos = todosLosReembolsos.concat(data || []);
                    console.log(`📄 Página cargada: ${data?.length ?? 0} registros (total acumulado: ${todosLosReembolsos.length})`);

                    if (!data || data.length < tamañoPagina) {
                        hayMas = false;
                    } else {
                        desde += tamañoPagina;
                    }
                }

                reembolsos = todosLosReembolsos;
                console.log('✅ Reembolsos cargados:', reembolsos.length);
                
                // 🔍 DEBUG: Ver estructura de los datos
                if (reembolsos.length > 0) {
                    console.log('📋 ESTRUCTURA DEL PRIMER REEMBOLSO:');
                    console.log(reembolsos[0]);
                    console.log('🔑 CAMPOS DISPONIBLES:', Object.keys(reembolsos[0]));
                }
                
                actualizarDashboard();
                cargarFiltroQuienEntrega(); // ✅ AGREGAR ESTA LÍNEA

                
            } catch (error) {
                console.error('❌ Error cargando datos:', error);
                mostrarNotificacion('Error cargando datos: ' + error.message, 'error');
            }
        }

        // ✅ AGREGAR ESTA FUNCIÓN
        async function cargarEmpleados() {
            try {
                const { data, error } = await supabase
                    .from('rnd_empleados')
                    .select('*')
                    .eq('activo', true)
                    .order('nombre');
                
                if (error) throw error;
                
                empleados = data || [];
                console.log('✅ Empleados cargados:', empleados.length);
                
            } catch (error) {
                console.error('Error cargando empleados:', error);
                empleados = [];
            }
        }


        // AUTOCOMPLETADO DE NOMBRES
        // BUSCAR o AGREGAR esta función
        function setupAutocompletado() {
            const input = document.getElementById('nombreBeneficiario');
            const suggestionsList = document.getElementById('suggestionsList');

            if (!input || !suggestionsList) return;

            // Remover listeners anteriores
            input.replaceWith(input.cloneNode(true));
            const newInput = document.getElementById('nombreBeneficiario');

            newInput.addEventListener('input', function() {
                const valor = this.value.toLowerCase().trim();
                suggestionsList.innerHTML = '';

                if (valor.length < 2) {
                    suggestionsList.style.display = 'none';
                    return;
                }

                const coincidencias = empleados.filter(emp =>
                    emp.nombre.toLowerCase().includes(valor)
                );

                if (coincidencias.length > 0) {
                    coincidencias.forEach(emp => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.textContent = emp.nombre;
                        item.onclick = () => {
                            newInput.value = emp.nombre;
                            suggestionsList.style.display = 'none';
                        };
                        suggestionsList.appendChild(item);
                    });
                    suggestionsList.style.display = 'block';
                } else {
                    // Si no hay coincidencias, mostrar advertencia
                    const warningItem = document.createElement('div');
                    warningItem.className = 'suggestion-item';
                    warningItem.style.cssText = 'background: #fed7d7; color: #c53030; border-left: 3px solid #e53e3e; font-weight: 600;';
                    warningItem.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Empleado no encontrado en el sistema';
                    suggestionsList.appendChild(warningItem);
                    suggestionsList.style.display = 'block';
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!newInput.contains(e.target) && !suggestionsList.contains(e.target)) {
                    suggestionsList.style.display = 'none';
                }
            });
        }

        function seleccionarNombre(nombre) {
            document.getElementById('nombreBeneficiario').value = nombre;
            document.getElementById('suggestionsList').style.display = 'none';
        }
        
        // ===============================
        // CREAR REEMBOLSO COMPLETO
        // ===============================
        // Variable global para controlar el procesamiento
        let procesandoReembolso = false;

        async function registrarReembolso() {
            // 1. VERIFICAR SI YA SE ESTÁ PROCESANDO
            if (procesandoReembolso) {
                mostrarNotificacion('Ya se está procesando un reembolso, espera...', 'warning');
                return;
            }
            
            // 2. OBTENER REFERENCIA AL BOTÓN
            const boton = document.querySelector('button[onclick="registrarReembolso()"]');
            
            try {
                // 3. MARCAR COMO PROCESANDO Y DESHABILITAR INTERFAZ
                procesandoReembolso = true;
                boton.disabled = true;
                boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validando...';
                
                // 4. VALIDACIONES BÁSICAS
                const nombre = document.getElementById('nombreBeneficiario').value.trim();
                const fecha = document.getElementById('fechaReembolso').value;
                const monto = parseFloat(document.getElementById('montoReembolso').value);
                const autoriza = document.getElementById('quienAutoriza').value.trim();
               // VALIDAR que el concepto sea una opción válida
                const conceptosPermitidos = ['ANUNCIOS EN PESEROS', 'ARRENDAMIENTOS', 'CARGA Y DESCARGA', 'CASA LIC FBV Y JBV', 'COMIDAS', 'COMISIONES', 'COMPENSACIONES', 'COMPRAS', 'DIVERSOS', 'DUPLICADOS DE LLAVES', 'EQ. DE COMPUTO', 'ESTACIONAMIENTO', 'GAS', 'GASTOS DIRECTIVOS', 'GUARDIA NACIONAL', 'HORAS EXTRAS', 'LA MARIPOSA', 'LAVANDERIA', 'LIMPIEZA', 'MANTTO EQ. DE TRANSP.', 'MODALIDAD 40', 'MUNICIPIO', 'PAPELERIA', 'PREVISION SOCIAL', 'PUBLICIDAD', 'RENTA TRAB FORANEOS', 'SUELDOS', 'TRABAJOS DE HERRERIA', 'TRANSITO LOCAL', 'VIATICOS', 'VIAJE DE MATERIAL FORANEO', 'VIGILANCIA NOCTURNA'];
                const concepto = document.getElementById('conceptoReembolso').value;

                if (!concepto || !conceptosPermitidos.includes(concepto)) {
                    mostrarNotificacion('Debes seleccionar un concepto válido', 'error');
                    return;
                }

                console.log('📝 Registrando reembolso:', { nombre, fecha, monto, autoriza, concepto });

                if (!nombre || !fecha || !monto || !autoriza || !concepto) {
                    mostrarNotificacion('Por favor completa todos los campos obligatorios', 'error');
                    return;
                }

                if (monto <= 0) {
                    mostrarNotificacion('El monto debe ser mayor a 0', 'error');
                    return;
                }

                // VALIDAR que la fecha no sea mayor a hoy + 1 día
                const fechaSeleccionada = new Date(fecha);
                const maxFechaPermitida = new Date();
                maxFechaPermitida.setDate(maxFechaPermitida.getDate() + 1);
                maxFechaPermitida.setHours(23, 59, 59, 999);

                if (fechaSeleccionada > maxFechaPermitida) {
                    mostrarNotificacion('No puedes capturar reembolsos con fecha mayor a mañana', 'error');
                    return;
                }
                // ✅ NUEVA VALIDACIÓN DE COMIDA POR BENEFICIARIO POR DÍA
                boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validando concepto...';
                const validacionComida = await validarComidaPorBeneficiarioPorDia(nombre, fecha, concepto);
                if (!validacionComida.valido) {
                    mostrarNotificacion(validacionComida.mensaje, 'error');
                    return; // Detener el registro
                }

                // 5. ✅ VALIDACIÓN OBLIGATORIA DE ARCHIVOS
                const archivos = document.getElementById('archivosReembolso').files;
                console.log('📁 Archivos seleccionados:', archivos.length);
                
                if (archivos.length === 0) {
                    mostrarNotificacion('❌ OBLIGATORIO: Debes adjuntar al menos un comprobante', 'error');
                    // Hacer focus en el input de archivos para llamar la atención
                    document.getElementById('archivosReembolso').focus();
                    return;
                }
                
                // 6. VALIDAR TIPOS Y TAMAÑOS DE ARCHIVOS
                const tiposPermitidos = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
                const tamañoMaximo = 10 * 1024 * 1024; // 10MB
                
                for (const archivo of archivos) {
                    if (!tiposPermitidos.includes(archivo.type)) {
                        mostrarNotificacion(`❌ Tipo de archivo no permitido: ${archivo.name}`, 'error');
                        return;
                    }
                    
                    if (archivo.size > tamañoMaximo) {
                        mostrarNotificacion(`❌ Archivo muy grande (max 10MB): ${archivo.name}`, 'error');
                        return;
                    }
                }
                
                const archivosBase64 = [];
                
                // 7. PROCESAR ARCHIVOS CON COMPRESIÓN
                boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando archivos...';
                
                for (const archivo of archivos) {
                    try {
                        const base64 = await convertirArchivoABase64(archivo); // Ya incluye compresión
                        archivosBase64.push({
                            nombre: archivo.name,
                            tipo: archivo.type,
                            tamaño: archivo.size,
                            base64: base64
                        });
                        console.log(`✅ Archivo procesado: ${archivo.name}`);
                    } catch (error) {
                        mostrarNotificacion(`Error procesando archivo "${archivo.name}": ${error.message}`, 'error');
                        return;
                    }
                }
                
                // 8. SUBIR ARCHIVOS (YA NO ES CONDICIONAL)
                boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo archivos...';
                
                console.log('☁️ Subiendo archivos a Supabase...');
                const archivosSubidos = await subirArchivosSupabase(archivosBase64);
                console.log('✅ Archivos subidos:', archivosSubidos);
                
                // 9. VALIDAR QUE SE SUBIERON CORRECTAMENTE
                if (archivosSubidos.length === 0) {
                    mostrarNotificacion('❌ Error: No se pudieron subir los archivos', 'error');
                    return;
                }
                
                if (archivosSubidos.length !== archivos.length) {
                    mostrarNotificacion(`⚠️ Advertencia: Solo se subieron ${archivosSubidos.length} de ${archivos.length} archivos`, 'warning');
                }
                
                // 10. GUARDAR EN BASE DE DATOS
                boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando en base de datos...';
                
                console.log('💾 Guardando reembolso en base de datos...');
                const { data, error } = await supabase
                    .from('rnd_reembolsos')
                    .insert({
                        nombre_beneficiario: nombre,
                        fecha: fecha,
                        monto: monto,
                        quien_autoriza: autoriza,
                        quien_entrega: currentUser.nombre,
                        concepto: concepto,
                        estado: 'pendiente',
                        usuario_registro: currentUser.email,
                        sucursal_usuario: currentUser.sucursal,
                        archivos: archivosSubidos  // ✅ Siempre tendrá archivos
                    })
                    .select()
                    .single();

                if (error) {
                    console.error('❌ Error insertando reembolso:', error);
                    throw error;
                }

                console.log('✅ Reembolso creado exitosamente:', data);
                mostrarNotificacion(`✅ Reembolso registrado con ${archivosSubidos.length} comprobante(s)`, 'success');
                
                // 11. LIMPIAR FORMULARIO
                document.getElementById('nombreBeneficiario').value = '';
                document.getElementById('fechaReembolso').value = '';
                document.getElementById('montoReembolso').value = '';
                document.getElementById('quienAutoriza').value = '';
                document.getElementById('conceptoReembolso').value = '';
                document.getElementById('archivosReembolso').value = '';
                
                // Limpiar también la lista de archivos mostrada
                const listaArchivos = document.getElementById('archivos-lista');
                if (listaArchivos) {
                    listaArchivos.innerHTML = '';
                }
                
                // 12. RECARGAR DATOS
                await cargarDatos();
                
            } catch (error) {
                console.error('❌ Error completo:', error);
                mostrarNotificacion('Error registrando reembolso: ' + error.message, 'error');
                
            } finally {
                // 13. SIEMPRE REHABILITAR INTERFAZ
                procesandoReembolso = false;
                boton.disabled = false;
                boton.innerHTML = '<i class="fas fa-save"></i> Registrar Reembolso';
            }
        }

        // ===============================
        // SUBIR ARCHIVOS A SUPABASE STORAGE
        // ===============================
        async function subirArchivosSupabase(archivos) {
            if (!archivos || archivos.length === 0) return [];
            
            const archivosSubidos = [];
            
            for (const archivo of archivos) {
                try {
                    const fileName = `${Date.now()}_${archivo.nombre}`;
                    console.log(`📤 Subiendo: ${fileName}`);
                    
                    // Convertir base64 a blob
                    const response = await fetch(`data:${archivo.tipo};base64,${archivo.base64}`);
                    const blob = await response.blob();
                    
                    // Subir a Supabase Storage
                    const { data, error } = await supabase.storage
                        .from('rnd-documentos')
                        .upload(`reembolsos/${fileName}`, blob, {
                            contentType: archivo.tipo
                        });
                    
                    if (error) {
                        console.error(`❌ Error subiendo ${fileName}:`, error);
                        continue; // Continuar con el siguiente archivo
                    }
                    
                    // Obtener URL pública
                    const { data: urlData } = supabase.storage
                        .from('rnd-documentos')
                        .getPublicUrl(`reembolsos/${fileName}`);
                    
                    archivosSubidos.push({
                        nombre: archivo.nombre,
                        tipo: archivo.tipo,
                        url: urlData.publicUrl,
                        path: data.path
                    });
                    
                    console.log(`✅ Archivo subido: ${fileName}`);
                    
                } catch (error) {
                    console.error('❌ Error procesando archivo:', error);
                    // Continuar con otros archivos
                }
            }
            
            return archivosSubidos;
        }

        // Función para comprimir imágenes
        // Función para comprimir imágenes con alta compresión
        function comprimirImagen(file, calidad = 0.3, maxWidth = 1200) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    let { width, height } = img;
                    
                    // Redimensionar si es muy grande
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Dibujar imagen redimensionada
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convertir a blob con 30% de calidad
                    canvas.toBlob(resolve, 'image/jpeg', 0.3);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Función mejorada para convertir archivos con alta compresión
        async function convertirArchivoABase64(archivo) {
            // Si es imagen y mayor a 200KB, comprimir agresivamente
            if (archivo.type.startsWith('image/') && archivo.size > 200000) {
                console.log(`Comprimiendo ${archivo.name} (${(archivo.size/1024/1024).toFixed(2)}MB)`);
                
                const archivoComprimido = await comprimirImagen(archivo, 0.3, 1200);
                console.log(`Comprimido a ${(archivoComprimido.size/1024/1024).toFixed(2)}MB`);
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(archivoComprimido);
                });
            }
            
            // Si no es imagen o es pequeña, procesar normal
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(archivo);
            });
        }


        // También actualizar el label en el HTML para indicar que es obligatorio
        // Cambiar el HTML de:
        // <label>Archivos Adjuntos</label>
        // Por:
        // <label>Archivos Adjuntos *</label>

        // Y agregar una nota visual en el formulario
        function actualizarLabelArchivos() {
            const labelArchivos = document.querySelector('label[for="archivosReembolso"]') || 
                                document.querySelector('.form-group label');
            
            if (labelArchivos && !labelArchivos.textContent.includes('*')) {
                labelArchivos.innerHTML = 'Archivos Adjuntos <span style="color: #e53e3e;">*</span>';
            }
            
            // Agregar texto explicativo
            const fileUploadDiv = document.querySelector('.file-upload');
            if (fileUploadDiv) {
                const existingNote = fileUploadDiv.querySelector('.required-note');
                if (!existingNote) {
                    const requiredNote = document.createElement('p');
                    requiredNote.className = 'required-note';
                    requiredNote.style.cssText = 'font-size: 12px; color: #e53e3e; margin-top: 5px; font-weight: 600;';
                    requiredNote.textContent = '* Obligatorio: Debe adjuntar al menos un comprobante';
                    fileUploadDiv.appendChild(requiredNote);
                }
            }
        }

        // Llamar esta función cuando se cargue la página
        document.addEventListener('DOMContentLoaded', function() {
            actualizarLabelArchivos();
        });
        async function enviarReembolso(data) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = GOOGLE_SCRIPT_URL;
            form.target = 'hidden-iframe';
            form.style.display = 'none';
            
            const iframe = document.createElement('iframe');
            iframe.name = 'hidden-iframe';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            const datos = {
                action: 'INSERT_REEMBOLSO',
                data: data
            };
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'postData';
            input.value = JSON.stringify(datos);
            form.appendChild(input);
            
            document.body.appendChild(form);
            form.submit();
            
            return new Promise(resolve => {
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                    resolve({ success: true });
                }, 3000);
            });
        }

        async function actualizarReembolso(reembolsoData) {
            try {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = GOOGLE_SCRIPT_URL;
                form.target = 'hidden-iframe-update';
                form.style.display = 'none';
                
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden-iframe-update';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                const datos = {
                    action: 'UPDATE_REEMBOLSO',
                    data: reembolsoData
                };
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'postData';
                input.value = JSON.stringify(datos);
                form.appendChild(input);
                
                document.body.appendChild(form);
                form.submit();
                
                // Esperar y limpiar
                return new Promise(resolve => {
                    setTimeout(() => {
                        document.body.removeChild(form);
                        document.body.removeChild(iframe);
                        resolve({ success: true });
                    }, 3000);
                });
                
            } catch (error) {
                console.error('Error actualizando reembolso:', error);
                return { success: false, error: error.message };
            }
        }

        async function aprobarIndividual(id) {
            const reembolso = reembolsos.find(r => r.id === id);
            if (!reembolso) return;
            
            try {
                reembolso.estado = 'aprobado';
                reembolso.progreso = 75;
                reembolso.fechaAprobacion = new Date().toISOString();
                reembolso.usuarioAprobacion = currentUser.email;
                
                const response = await actualizarReembolso(reembolso);
                
                if (response.success) {
                    mostrarNotificacion('Reembolso aprobado', 'success');
                    await cargarDatos();
                    cargarReembolsosRevision();
                    actualizarDashboard();
                } else {
                    mostrarNotificacion('Error: ' + response.error, 'error');
                }

                
            } catch (error) {
                mostrarNotificacion('Error aprobando reembolso', 'error');
            }
        }

        async function rechazarReembolso(id) {
            const motivo = prompt('Motivo del rechazo:');
            if (!motivo) return;
            
            const reembolso = reembolsos.find(r => r.id === id);
            if (!reembolso) return;
            
            try {
                reembolso.estado = 'rechazado';
                reembolso.progreso = 0;
                reembolso.fechaRechazo = new Date().toISOString();
                reembolso.usuarioRechazo = currentUser.email;
                reembolso.motivoRechazo = motivo;
                
                await actualizarReembolso(reembolso);
                mostrarNotificacion('Reembolso rechazado', 'success');
                cargarReembolsosRevision();
                actualizarDashboard();
                
            } catch (error) {
                mostrarNotificacion('Error rechazando reembolso', 'error');
            }
        }

        // Función para marcar como entregado
        async function marcarComoEntregado(id) {
            const confirmacion = confirm('¿Confirmar que se entregó el dinero para este reembolso?');
            if (!confirmacion) return;
            
            try {
                const reembolsoData = {
                    id: id,
                    fechaEntrega: new Date().toISOString(),
                    usuarioEntrega: currentUser.email
                };
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'MARCAR_ENTREGADO',
                        data: reembolsoData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    mostrarNotificacion('Reembolso marcado como entregado', 'success');
                    await cargarDatos();
                    generarComprobanteEntrega(id);
                } else {
                    mostrarNotificacion('Error: ' + result.error, 'error');
                }
                
            } catch (error) {
                mostrarNotificacion('Error marcando como entregado', 'error');
            }
        }


        // Función para solicitar entrega (Marcela)
        // FUNCIÓN CORREGIDA: Solicitar entrega general (Solo Supabase)
        async function solicitarEntregaLote() {
            const reembolsosAprobados = reembolsos.filter(r => r.estado === 'aprobado');
            
            if (reembolsosAprobados.length === 0) {
                mostrarNotificacion('No hay comprobantes aprobados para solicitar entrega', 'error');
                return;
            }
            
            const confirmacion = confirm(
                `¿Solicitar entrega de dinero?\n\n` +
                `• Comprobantes: ${reembolsosAprobados.length}\n` +
                `• Total: $${reembolsosAprobados.reduce((sum, r) => sum + parseFloat(r.monto), 0).toLocaleString()}\n\n` +
                `Se actualizará el estado a "solicitado_entrega".`
            );
            
            if (!confirmacion) return;
            
            try {
                mostrarNotificacion('Actualizando estados...', 'info');

                const sucursalRegistro = reembolsosAprobados[0].sucursal_usuario; // Sucursal del usuario que registró
                const numeroSolicitud = generarNumeroSolicitud(sucursalRegistro);

                // Actualizar estados en Supabase SOLAMENTE
                const updatePromises = reembolsosAprobados.map(reembolso => 
                    supabase
                        .from('rnd_reembolsos')
                        .update({
                            estado: 'solicitado_entrega',
                            numero_solicitud: numeroSolicitud,
                            fecha_solicitud_entrega: new Date().toISOString()
                        })
                        .eq('id', reembolso.id)
                );
                
                await Promise.all(updatePromises);
                
                // Actualizar los datos locales
                reembolsosAprobados.forEach(r => {
                    r.estado = 'solicitado_entrega';
                    r.numero_solicitud = numeroSolicitud;
                });
                
                mostrarNotificacion(
                    `Solicitud de entrega generada\n` +
                    `• Número de solicitud: ${numeroSolicitud}\n` +
                    `• Comprobantes actualizados: ${reembolsosAprobados.length}`,
                    'success'
                );
                
                // Recargar datos y vista
                await cargarDatos();
                cargarGestionEntregas();
                
            } catch (error) {
                console.error('Error procesando solicitud:', error);
                mostrarNotificacion('Error procesando solicitud: ' + error.message, 'error');
            }
        }

        // ===============================
        // ACTUALIZAR REEMBOLSO (Reemplazar updateReembolso)
        // ===============================
        async function updateReembolso(id, campo, valor) {
            try {
                const updates = {};
                updates[campo] = valor;
                
                const { data, error } = await supabase
                    .from('rnd_reembolsos')
                    .update(updates)
                    .eq('id', id)
                    .select()
                    .single();

                if (error) throw error;

                // Actualizar en la lista local
                const index = reembolsos.findIndex(r => r.id === id);
                if (index !== -1) {
                    reembolsos[index] = { ...reembolsos[index], ...updates };
                }

                return { success: true, data };
            } catch (error) {
                console.error('Error actualizando reembolso:', error);
                return { success: false, error: error.message };
            }
        }



        // Función auxiliar (agregar)
        async function enviarDatosForm(datos) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = GOOGLE_SCRIPT_URL;
            form.target = 'hidden-iframe-temp';
            form.style.display = 'none';
            
            const iframe = document.createElement('iframe');
            iframe.name = 'hidden-iframe-temp';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'postData';
            input.value = JSON.stringify(datos);
            form.appendChild(input);
            
            document.body.appendChild(form);
            form.submit();
            
            return new Promise(resolve => {
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                    resolve({ success: true });
                }, 3000);
            });
        }

        // Función para confirmar entrega (Irma)
        async function confirmarEntregaLote() {
            const reembolsosSolicitados = reembolsos.filter(r => r.estado === 'solicitado_entrega');
            
            if (reembolsosSolicitados.length === 0) {
                mostrarNotificacion('No hay solicitudes pendientes', 'error');
                return;
            }
            
            const confirmacion = confirm(`¿Confirmar entrega de ${reembolsosSolicitados.length} reembolsos?`);
            if (!confirmacion) return;
            
            try {
                mostrarNotificacion('Confirmando entrega...', 'info');
                
                // NUEVA LLAMADA A SUPABASE
                const updatePromises = reembolsosSolicitados.map(reembolso =>
                    supabase
                        .from('rnd_reembolsos')
                        .update({ estado: 'entregado' })
                        .eq('id', reembolso.id)
                );
                
                await Promise.all(updatePromises);
                
                mostrarNotificacion('Entrega confirmada exitosamente', 'success');
                await cargarDatos();
                cargarGestionEntregas();
                
            } catch (error) {
                mostrarNotificacion('Error confirmando entrega: ' + error.message, 'error');
            }
        }
        // ===============================
        // ELIMINAR REEMBOLSO (Nueva función)
        // ===============================
        async function eliminarReembolso(id) {
            const confirmacion = confirm('¿Estás seguro de que deseas eliminar este reembolso?');
            if (!confirmacion) return;
            
            try {
                const { error } = await supabase
                    .from('rnd_reembolsos')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                mostrarNotificacion('Reembolso eliminado exitosamente', 'success');
                await cargarDatos();
                
            } catch (error) {
                mostrarNotificacion('Error eliminando reembolso: ' + error.message, 'error');
            }
        }
        // ===============================
        // REGISTRAR ACTIVIDAD (Nueva función)
        // ===============================
        async function registrarActividad(tipo, descripcion, datosAdicionales = {}) {
            try {
                await supabase
                    .from('rnd_actividades')
                    .insert({
                        tipo: tipo,
                        descripcion: descripcion,
                        usuario: (currentUser && currentUser.email) || 'sistema',
                        datos_adicionales: datosAdicionales
                    });
            } catch (error) {
                console.error('Error registrando actividad:', error);
            }
        }


        function generarNumeroSolicitud(sucursal) {
            const fecha = new Date();
            const año = fecha.getFullYear();
            const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
            const dia = fecha.getDate().toString().padStart(2, '0');
            const hora = fecha.getHours().toString().padStart(2, '0');
            const minuto = fecha.getMinutes().toString().padStart(2, '0');

            return `SOL-${sucursal}-${año}${mes}${dia}-${hora}${minuto}`;
        }


        function limpiarFormulario() {
            document.getElementById('nombreBeneficiario').value = '';
            document.getElementById('montoReembolso').value = '';
            document.getElementById('quienAutoriza').value = '';
            document.getElementById('conceptoReembolso').value = '';
            document.getElementById('archivosReembolso').value = '';
            document.getElementById('archivos-lista').innerHTML = '';
            
            // Resetear fecha/hora actual
            const ahora = new Date();
            ahora.setMinutes(ahora.getMinutes() - ahora.getTimezoneOffset());
            document.getElementById('fechaReembolso').value = ahora.toISOString().slice(0,16);

            // Establecer fecha máxima permitida (hoy + 1 día)
            const maxFecha = new Date();
            maxFecha.setDate(maxFecha.getDate() + 1);
            maxFecha.setMinutes(maxFecha.getMinutes() - maxFecha.getTimezoneOffset());
            document.getElementById('fechaReembolso').max = maxFecha.toISOString().slice(0,16);
        }

        // MOSTRAR ARCHIVOS SELECCIONADOS
        function mostrarArchivosSeleccionados() {
            const archivos = Array.from(document.getElementById('archivosReembolso').files);
            const container = document.getElementById('archivos-lista');
            
            if (archivos.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div style="margin-top: 15px;">
                    <h4>Archivos seleccionados:</h4>
                    <ul style="list-style: none; padding: 0;">
                        ${archivos.map((archivo, index) => `
                            <li style="padding: 8px; background: #f7fafc; margin: 5px 0; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-file"></i>
                                <span><strong>${archivo.name}</strong></span>
                                <small style="color: #718096;">(${(archivo.size / 1024 / 1024).toFixed(2)} MB)</small>
                                <span style="color: #38a169;">✓ Listo</span>
                            </li>
                        `).join('')}
                    </ul>
                    <div style="margin-top: 10px; padding: 10px; background: #e6fffa; border-radius: 6px; border-left: 3px solid #38a169;">
                        <small><strong>Total:</strong> ${archivos.length} archivos - ${(archivos.reduce((sum, f) => sum + f.size, 0) / 1024 / 1024).toFixed(2)} MB</small>
                    </div>
                </div>
            `;
        }

        // CARGA MASIVA DESDE EXCEL
        function descargarPlantillaExcel() {
            const plantilla = [
                ['Nombre', 'Monto', 'Quien Autoriza', 'Concepto'],
                ['Juan Pérez', '500.00', 'Lic Fernando Balderrama', 'Gastos de transporte'],
                ['Ana López', '250.00', 'Lic Diana Soto', 'Comida de trabajo'],
                ['Luis Martín', '1000.00', 'Alejandra Zepeda', 'Material de oficina']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(plantilla);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reembolsos");
            
            XLSX.writeFile(wb, "Plantilla_Reembolsos.xlsx");
            mostrarNotificacion('Plantilla descargada', 'success');
        }

        async function procesarExcelMasivo() {
            const archivo = document.getElementById('excelMasivo').files[0];
            if (!archivo) return;
            
            try {
                const data = await leerArchivoExcel(archivo);
                mostrarPreviewExcel(data);
            } catch (error) {
                mostrarNotificacion('Error leyendo archivo Excel: ' + error.message, 'error');
            }
        }

        function leerArchivoExcel(archivo) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(archivo);
            });
        }

        function mostrarPreviewExcel(data) {
            const container = document.getElementById('preview-excel');

            if (data.length === 0) {
                container.innerHTML = '<p style="color: #e53e3e;">El archivo Excel está vacío</p>';
                container.style.display = 'block';
                return;
            }

            // Lista oficial de autorizadores
            const autorizadoresOficiales = [
                'Alejandra Zepeda', 'Andrés Salazar', 'Cristina Valadez', 'David Ramírez',
                'Diana Gpe. Rivera Ortega', 'Felipe Reyes Cota', 'Flor Santos', 'Francisco Armenta',
                'Gisela Armenta', 'Gmo. Tostado', 'Guillermo Corrales Cruz',
                'Hugo Andrés Salazar Osorio', 'Ing Javier Pinedo', 'Jasive Trasviña',
                'José Urías', 'Karla Ochoa', 'Lic Ana Maria', 'Lic Diana Soto',
                'Lic Fernando Balderrama', 'Lic Fernando Olais', 'Lic Jose Balderrama',
                'Luis Adrian Monroy Torres', 'Rosa María De Balderrama', 'Victor Hugo Diaz Navarro'
            ];

            const reembolsosValidos = data.filter(row => {
                const tieneAutorizadorValido = row['Quien Autoriza'] && autorizadoresOficiales.includes(row['Quien Autoriza']);
                return row.Nombre && row.Monto && tieneAutorizadorValido && row.Concepto;
            });

            const registrosInvalidos = data.length - reembolsosValidos.length;
            const autorizadoresInvalidos = data
                .filter(row => row['Quien Autoriza'] && !autorizadoresOficiales.includes(row['Quien Autoriza']))
                .map(row => row['Quien Autoriza']);

            container.innerHTML = `
                <h4>Preview del archivo Excel</h4>
                <p><strong>Total registros:</strong> ${data.length}</p>
                <p><strong>Registros válidos:</strong> ${reembolsosValidos.length}</p>
                ${registrosInvalidos > 0 ? `
                    <div style="background: #fff5f5; border: 1px solid #fc8181; padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <p style="color: #c53030; margin: 0;"><strong>⚠ ${registrosInvalidos} registros rechazados</strong></p>
                        ${autorizadoresInvalidos.length > 0 ? `
                            <p style="color: #c53030; margin: 5px 0 0 0; font-size: 0.9em;">
                                Autorizadores inválidos encontrados: ${[...new Set(autorizadoresInvalidos)].join(', ')}
                            </p>
                        ` : ''}
                    </div>
                ` : ''}
                
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin: 15px 0;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f7fafc; position: sticky; top: 0;">
                            <tr>
                                <th style="padding: 10px; border-bottom: 1px solid #e2e8f0;">Nombre</th>
                                <th style="padding: 10px; border-bottom: 1px solid #e2e8f0;">Monto</th>
                                <th style="padding: 10px; border-bottom: 1px solid #e2e8f0;">Autoriza</th>
                                <th style="padding: 10px; border-bottom: 1px solid #e2e8f0;">Concepto</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reembolsosValidos.slice(0, 10).map(row => `
                                <tr>
                                    <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">${row.Nombre || ''}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">$${parseFloat(row.Monto || 0).toFixed(2)}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">${row['Quien Autoriza'] || ''}</td>
                                    <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">${row.Concepto || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                ${reembolsosValidos.length > 0 ? `
                    <button class="btn btn-success" onclick="procesarReembolsosMasivos(${JSON.stringify(reembolsosValidos).replace(/"/g, '&quot;')})">
                        <i class="fas fa-upload"></i> Procesar ${reembolsosValidos.length} Reembolsos
                    </button>
                ` : '<p style="color: #e53e3e;">No hay registros válidos para procesar</p>'}
            `;
            
            container.style.display = 'block';
        }

        async function procesarReembolsosMasivos(data) {
            mostrarNotificacion(`Procesando ${data.length} reembolsos...`, 'info');
            
            let exitosos = 0;
            let errores = 0;
            
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                
                try {
                    const reembolsoData = {
                        id: Date.now() + i,
                        nombreBeneficiario: row.Nombre,
                        fecha: new Date().toISOString(),
                        monto: parseFloat(row.Monto),
                        quienAutoriza: row['Quien Autoriza'],
                        quienEntrega: currentUser.nombre,
                        concepto: row.Concepto,
                        estado: 'pendiente',
                        fechaRegistro: new Date().toISOString(),
                        usuario_registro: currentUser.email,
                        archivos: [],
                        progreso: 25,
                        esMasivo: true
                    };
                    
                    const response = await enviarReembolso(reembolsoData);
                    
                    if (response.success) {
                        exitosos++;
                        reembolsos.push(reembolsoData);
                        
                        // Actualizar nombres para autocompletado
                        if (!nombresRegistrados.includes(row.Nombre)) {
                            nombresRegistrados.push(row.Nombre);
                        }
                    } else {
                        errores++;
                    }
                    
                    // Pausa entre envíos
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                } catch (error) {
                    errores++;
                    console.error(`Error procesando registro ${i + 1}:`, error);
                }
            }
            
            mostrarNotificacion(`Proceso completado: ${exitosos} exitosos, ${errores} errores`, 
                errores > 0 ? 'warning' : 'success');
                
            // Limpiar preview
            document.getElementById('preview-excel').style.display = 'none';
            document.getElementById('excelMasivo').value = '';
            
            actualizarDashboard();
        }

        function cargarGestionEntregas() {
            const container = document.getElementById('contenido-entregas');
            
            let reembolsosFiltrados = filtrarReembolsosPorUsuario(reembolsos);
            const reembolsosAprobados = reembolsosFiltrados.filter(r => r.estado === 'aprobado');
            const reembolsosSolicitados = reembolsosFiltrados.filter(r => r.estado === 'solicitado_entrega');
            const reembolsosEntregados = reembolsosFiltrados.filter(r => r.estado === 'entregado');
            
            // NUEVA FUNCIONALIDAD: Agrupar aprobados por numero_lote
            const lotesPorNumero = {};
            reembolsosAprobados.forEach(reembolso => {
                const numeroLote = reembolso.numero_lote || 'SIN_LOTE';
                if (!lotesPorNumero[numeroLote]) {
                    lotesPorNumero[numeroLote] = [];
                }
                lotesPorNumero[numeroLote].push(reembolso);
            });
            
            container.innerHTML = `
                ${Object.keys(lotesPorNumero).length > 0 ? `
                    <div style="background: #f0fff4; border: 2px solid #38a169; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="color: #2f855a; margin-bottom: 15px;">
                            <i class="fas fa-check-circle"></i> Aprobados - Listos para Solicitar por Lote (${reembolsosAprobados.length})
                        </h3>
                        
                        ${Object.keys(lotesPorNumero).map(numeroLote => {
                            const reembolsosDelLote = lotesPorNumero[numeroLote];
                            const totalLote = reembolsosDelLote.reduce((sum, r) => sum + parseFloat(r.monto), 0);
                            const primerReembolso = reembolsosDelLote[0];
                            const sucursal = primerReembolso.sucursal_usuario || 'N/A';
                            
                            return `
                                <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 5px solid #38a169;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                                        <div>
                                            <h4 style="margin: 0; color: #1a365d;">
                                                <i class="fas fa-layer-group"></i> Lote: ${numeroLote}
                                            </h4>
                                            <div style="display: flex; gap: 15px; margin-top: 8px; align-items: center; flex-wrap: wrap;">
                                                <span style="background: #38a169; color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: bold;">
                                                    ${sucursal}
                                                </span>
                                                <span style="color: #4a5568; font-size: 14px;">
                                                    <strong>${reembolsosDelLote.length}</strong> reembolsos
                                                </span>
                                                <span style="color: #1a365d; font-size: 16px; font-weight: bold;">
                                                    Total: $${totalLote.toLocaleString()}
                                                </span>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <button class="btn btn-warning" onclick="solicitarEntregaLoteEspecifico('${numeroLote}')" style="padding: 10px 20px; font-size: 14px; background: #d69e2e; border: none; color: white; border-radius: 8px; cursor: pointer;">
                                                <i class="fas fa-file-pdf"></i> Solicitar Entrega de Este Lote
                                            </button>
                                            <button class="btn btn-primary" onclick="toggleLoteDetalle('${numeroLote.replace(/[^a-zA-Z0-9]/g, '_')}')" style="padding: 8px 16px; font-size: 14px;">
                                                <i class="fas fa-chevron-down" id="icon-${numeroLote.replace(/[^a-zA-Z0-9]/g, '_')}"></i> 
                                                <span id="texto-${numeroLote.replace(/[^a-zA-Z0-9]/g, '_')}">Ver Detalle</span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="detalle-${numeroLote.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none; margin-top: 15px;">
                                        <div style="background: #f8f9fa; border-radius: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch;">
                                            <table style="width: 100%; border-collapse: collapse; min-width: 500px;">
                                                <thead style="background: #e9ecef;">
                                                    <tr>
                                                        <th style="padding: 12px; text-align: left;">Beneficiario</th>
                                                        <th style="padding: 12px; text-align: left;">Concepto</th>
                                                        <th style="padding: 12px; text-align: right;">Monto</th>
                                                        <th style="padding: 12px; text-align: center;">Fecha</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${reembolsosDelLote.map(r => `
                                                        <tr style="border-bottom: 1px solid #e9ecef;">
                                                            <td style="padding: 12px; font-weight: 500;">${r.nombre_beneficiario}</td>
                                                            <td style="padding: 12px;">${r.concepto}</td>
                                                            <td style="padding: 12px; text-align: right; font-weight: 600;">$${parseFloat(r.monto).toLocaleString()}</td>
                                                            <td style="padding: 12px; text-align: center;">${new Date(r.fecha).toLocaleDateString()}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}

                ${reembolsosSolicitados.length > 0 ? `
                    <div style="background: #fff5e6; border: 2px solid #d69e2e; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="color: #744210; margin-bottom: 15px;">
                            <i class="fas fa-hourglass-half"></i> Esperando Entrega por Lotes (${reembolsosSolicitados.length})
                        </h3>
                        
                        ${(() => {
                            // Agrupar solicitudes por lote
                            const lotesSolicitados = {};
                            reembolsosSolicitados.forEach(reembolso => {
                                const numeroLote = reembolso.numero_lote || 'SIN_LOTE';
                                if (!lotesSolicitados[numeroLote]) {
                                    lotesSolicitados[numeroLote] = [];
                                }
                                lotesSolicitados[numeroLote].push(reembolso);
                            });
                            
                            return Object.keys(lotesSolicitados).map(numeroLote => {
                                const reembolsosDelLote = lotesSolicitados[numeroLote];
                                const totalLote = reembolsosDelLote.reduce((sum, r) => sum + parseFloat(r.monto), 0);
                                const numeroSolicitud = reembolsosDelLote[0].numero_solicitud;
                                
                                return `
                                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 5px solid #d69e2e;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                                            <div>
                                                <h4 style="margin: 0; color: #744210;">
                                                    <i class="fas fa-layer-group"></i> Lote: ${numeroLote}
                                                </h4>
                                                <div style="display: flex; gap: 15px; margin-top: 8px; align-items: center; flex-wrap: wrap;">
                                                    <span style="background: #d69e2e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: bold;">
                                                        ${reembolsosDelLote.length} reembolsos
                                                    </span>
                                                    <span style="color: #744210; font-size: 16px; font-weight: bold;">
                                                        Total: $${totalLote.toLocaleString()}
                                                    </span>
                                                    <span style="color: #4a5568; font-size: 13px;">
                                                        Solicitud: ${numeroSolicitud}
                                                    </span>
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                <button class="btn btn-primary" onclick="toggleLoteDetalleSolicitud('${numeroLote.replace(/[^a-zA-Z0-9]/g, '_')}')" style="padding: 8px 16px; font-size: 14px;">
                                                    <i class="fas fa-chevron-down" id="icon-sol-${numeroLote.replace(/[^a-zA-Z0-9]/g, '_')}"></i> 
                                                    <span id="texto-sol-${numeroLote.replace(/[^a-zA-Z0-9]/g, '_')}">Ver Detalle</span>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div id="detalle-sol-${numeroLote.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none; margin-top: 15px;">
                                            <div style="background: #f8f9fa; border-radius: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch;">
                                                <table style="width: 100%; border-collapse: collapse; min-width: 500px;">
                                                    <thead style="background: #e9ecef;">
                                                        <tr>
                                                            <th style="padding: 12px; text-align: left;">Beneficiario</th>
                                                            <th style="padding: 12px; text-align: right;">Monto</th>
                                                            <th style="padding: 12px; text-align: left;">Concepto</th>
                                                            <th style="padding: 12px; text-align: center;">Fecha</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${reembolsosDelLote.map(r => `
                                                            <tr style="border-bottom: 1px solid #e9ecef;">
                                                                <td style="padding: 12px; font-weight: 500;">${r.nombre_beneficiario}</td>
                                                                <td style="padding: 12px; text-align: right; font-weight: 600;">$${parseFloat(r.monto).toLocaleString()}</td>
                                                                <td style="padding: 12px;">${r.concepto}</td>
                                                                <td style="padding: 12px; text-align: center;">${new Date(r.fecha).toLocaleDateString()}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <!-- Sección para subir evidencia específica del lote -->
                                            <div style="background: #e6fffa; padding: 20px; border-radius: 10px; margin-top: 15px; border-left: 4px solid #38a169;">
                                                <h5 style="color: #2f855a; margin-bottom: 15px;">
                                                    <i class="fas fa-camera"></i> Confirmar Entrega de Lote ${numeroLote}
                                                </h5>
                                                <p style="margin-bottom: 15px; color: #4a5568; font-size: 14px;">
                                                    Sube el comprobante firmado específico para este lote.
                                                </p>
                                                <button 
                                                    class="btn btn-success" 
                                                    onclick="subirEvidenciaEntregaLote('${numeroLote}')" 
                                                    style="padding: 10px 20px; font-size: 14px;">
                                                    <i class="fas fa-camera"></i> Subir Comprobante para ${numeroLote}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        })()}
                    </div>
                ` : ''}
                ${reembolsosEntregados.length > 0 ? `
                    <div style="background: #e6fffa; border: 2px solid #38a169; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="color: #2f855a; margin-bottom: 15px;">
                            <i class="fas fa-check-double"></i> Entregados Recientemente (${reembolsosEntregados.length})
                        </h3>
                        
                        <div style="background: white; border-radius: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 15px 0;">
                            <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left;">Beneficiario</th>
                                        <th style="padding: 12px; text-align: right;">Monto</th>
                                        <th style="padding: 12px; text-align: center;">Fecha Entrega</th>
                                        <th style="padding: 12px; text-align: center;">Evidencia</th>
                                        <th style="padding: 12px; text-align: center;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reembolsosEntregados.map(r => `
                                        <tr style="border-bottom: 1px solid #e9ecef;">
                                            <td style="padding: 12px; font-weight: 500;">${r.nombre_beneficiario}</td>
                                            <td style="padding: 12px; text-align: right; font-weight: 600;">$${parseFloat(r.monto).toLocaleString()}</td>
                                            <td style="padding: 12px; text-align: center;">
                                                ${r.fecha_entrega ? new Date(r.fecha_entrega).toLocaleDateString('es-MX') : 'N/A'}
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                ${(r.evidencia_entrega && 
                                                ((Array.isArray(r.evidencia_entrega) && r.evidencia_entrega.length > 0) || 
                                                    (typeof r.evidencia_entrega === 'object' && r.evidencia_entrega !== null))) ? `
                                                    <span style="background: #c6f6d5; color: #2f855a; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                                        <i class="fas fa-check"></i> Con evidencia
                                                    </span>
                                                ` : `
                                                    <span style="background: #fed7d7; color: #c53030; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                                                        <i class="fas fa-times"></i> Sin evidencia
                                                    </span>
                                                `}
                                            </td>
                                            <td style="padding: 12px; text-align: center;">
                                                <button onclick="verDetalles('${r.id}')" class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;">
                                                    <i class="fas fa-eye"></i> Ver
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="text-align: center; margin-top: 15px;">
                            <p><strong>Total entregado:</strong> $${reembolsosEntregados.reduce((sum, r) => sum + parseFloat(r.monto), 0).toLocaleString()}</p>
                        </div>
                    </div>
                ` : ''}

                ${Object.keys(lotesPorNumero).length === 0 && reembolsosSolicitados.length === 0 && reembolsosEntregados.length === 0 ? `
                    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <i class="fas fa-inbox" style="font-size: 48px; color: #718096; margin-bottom: 20px;"></i>
                        <h3 style="color: #4a5568; margin-bottom: 10px;">No hay comprobantes para gestionar entregas</h3>
                        <p style="color: #718096;">Los comprobantes aparecerán aquí cuando estén aprobados o listos para entrega.</p>
                    </div>
                ` : ''}
            `;
        }

        // Función para toggle de detalles en solicitudes
        function toggleLoteDetalleSolicitud(loteId) {
            const detalle = document.getElementById(`detalle-sol-${loteId}`);
            const icon = document.getElementById(`icon-sol-${loteId}`);
            const texto = document.getElementById(`texto-sol-${loteId}`);
            
            if (detalle.style.display === 'none') {
                detalle.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                texto.textContent = 'Ocultar Detalle';
            } else {
                detalle.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                texto.textContent = 'Ver Detalle';
            }
        }

        // Función para confirmar entrega de lote específico
        // Función para confirmar entrega de lote específico (SIN evidencia)
        async function confirmarEntregaLoteEspecifico(numeroLote) {
            const reembolsosDelLote = reembolsos.filter(r => 
                r.estado === 'solicitado_entrega' && r.numero_lote === numeroLote
            );
            
            const confirmacion = confirm(
                `¿Confirmar entrega MANUAL del Lote ${numeroLote}?\n\n` +
                `• Comprobantes: ${reembolsosDelLote.length}\n` +
                `• Total: $${reembolsosDelLote.reduce((sum, r) => sum + parseFloat(r.monto), 0).toLocaleString()}\n\n` +
                `NOTA: Se marcará como entregado SIN evidencia fotográfica.`
            );
            
            if (!confirmacion) return;
            
            try {
                // Actualizar todos los reembolsos del lote a "entregado"
                const updatePromises = reembolsosDelLote.map(reembolso => 
                    supabase
                        .from('rnd_reembolsos')
                        .update({
                            estado: 'entregado',
                            fecha_entrega: new Date().toISOString(),
                            usuario_entrega: currentUser.email
                        })
                        .eq('id', reembolso.id)
                );
                
                await Promise.all(updatePromises);
                
                mostrarNotificacion(`Lote ${numeroLote} marcado como entregado MANUALMENTE`, 'success');
                await cargarDatos();
                cargarGestionEntregas();
                
            } catch (error) {
                mostrarNotificacion('Error confirmando entrega: ' + error.message, 'error');
            }
        }


        // Función para subir evidencia de lote específico
        async function subirEvidenciaEntregaLote(numeroLote) {
            // Crear input de archivo dinámicamente
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,application/pdf';
            input.multiple = false;
            
            input.onchange = async function(event) {
                const archivo = event.target.files[0];
                
                if (!archivo) return;
                
                // Validar tamaño (10MB máximo)
                if (archivo.size > 10 * 1024 * 1024) {
                    mostrarNotificacion('El archivo es muy grande. Máximo 10MB', 'error');
                    return;
                }
                
                // Validar tipo
                const tiposPermitidos = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
                if (!tiposPermitidos.includes(archivo.type)) {
                    mostrarNotificacion('Tipo de archivo no permitido. Solo JPG, PNG, PDF', 'error');
                    return;
                }
                
                try {
                    mostrarNotificacion(`Subiendo evidencia para lote ${numeroLote}...`, 'info');
                    
                    // Obtener reembolsos del lote
                    const reembolsosDelLote = reembolsos.filter(r => 
                        r.estado === 'solicitado_entrega' && r.numero_lote === numeroLote
                    );
                    
                    if (reembolsosDelLote.length === 0) {
                        mostrarNotificacion('No se encontraron reembolsos del lote', 'error');
                        return;
                    }
                    
                    // Subir archivo a Supabase Storage
                    const timestamp = Date.now();
                    const random = Math.floor(Math.random() * 10000);
                    const extension = archivo.name.split('.').pop();
                    const nombreArchivo = `evidencia_lote_${numeroLote}_${timestamp}_${random}.${extension}`;

                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('rnd-documentos')
                        .upload(`evidencias_entrega/${nombreArchivo}`, archivo, {
                            cacheControl: '3600',
                            upsert: true
                        });
                    
                    if (uploadError) {
                        console.error('Error subiendo archivo:', uploadError);
                        mostrarNotificacion('Error subiendo archivo: ' + uploadError.message, 'error');
                        return;
                    }
                    
                    // Obtener URL pública del archivo
                    const { data: { publicUrl } } = supabase.storage
                        .from('rnd-documentos')
                        .getPublicUrl(`evidencias_entrega/${nombreArchivo}`);
                    
                    // Preparar objeto de evidencia
                    const evidenciaEntrega = {
                        url: publicUrl,
                        path: `evidencias_entrega/${nombreArchivo}`,
                        tipo: archivo.type,
                        nombre: archivo.name,
                        fecha_subida: new Date().toISOString(),
                        usuario_subida: currentUser.email,
                        numero_lote: numeroLote,
                        tamano: archivo.size
                    };
                    
                    // Actualizar todos los reembolsos del lote
                    const updatePromises = reembolsosDelLote.map(reembolso => 
                        supabase
                            .from('rnd_reembolsos')
                            .update({
                                estado: 'entregado',
                                fecha_entrega: new Date().toISOString(),
                                evidencia_entrega: evidenciaEntrega
                            })
                            .eq('id', reembolso.id)
                    );
                    
                    await Promise.all(updatePromises);
                    
                    // Actualizar datos locales
                    reembolsosDelLote.forEach(r => {
                        r.estado = 'entregado';
                        r.fecha_entrega = new Date().toISOString();
                        r.evidencia_entrega = evidenciaEntrega;
                    });
                    
                    mostrarNotificacion(
                        `Lote ${numeroLote} confirmado como entregado\n` +
                        `• Comprobantes actualizados: ${reembolsosDelLote.length}\n` +
                        `• Evidencia guardada: ${archivo.name}`,
                        'success'
                    );
                    
                    // Recargar datos y vista
                    await cargarDatos();
                    cargarGestionEntregas();
                    
                } catch (error) {
                    console.error('Error procesando evidencia:', error);
                    mostrarNotificacion('Error procesando evidencia: ' + error.message, 'error');
                }
            };
            
            // Simular clic para abrir selector de archivos
            input.click();
        }

        // FUNCIÓN CORREGIDA sin el campo inexistente
        async function solicitarEntregaLoteEspecifico(numeroLote) {
            // EVITAR DOBLE CLIC
            const boton = event.target;
            if (boton.disabled) return;
            boton.disabled = true;
            const reembolsosDelLote = reembolsos.filter(r => 
                r.estado === 'aprobado' && r.numero_lote === numeroLote
            );
            
            if (reembolsosDelLote.length === 0) {
                mostrarNotificacion('No hay comprobantes aprobados en este lote', 'error');
                return;
            }
            
            const totalLote = reembolsosDelLote.reduce((sum, r) => sum + parseFloat(r.monto), 0);
            
            const confirmacion = confirm(
                `¿Solicitar entrega del Lote ${numeroLote}?\n\n` +
                `• Comprobantes: ${reembolsosDelLote.length}\n` +
                `• Total: $${totalLote.toLocaleString()}\n\n` +
                `Se generará documento para imprimir.`
            );
            
            if (!confirmacion) return;
            
            try {
                mostrarNotificacion('Actualizando estados en Supabase...', 'info');

                const sucursalRegistro = reembolsosDelLote[0].sucursal_usuario; // Sucursal del usuario que registró
                const numeroSolicitud = generarNumeroSolicitud(sucursalRegistro);

                console.log('Actualizando lote:', numeroLote);
                console.log('Reembolsos a actualizar:', reembolsosDelLote.length);
                
                // ACTUALIZAR SIN EL CAMPO fecha_solicitud_entrega
                for (const reembolso of reembolsosDelLote) {
                    const { data, error } = await supabase
                        .from('rnd_reembolsos')
                        .update({
                            estado: 'solicitado_entrega',
                            numero_solicitud: numeroSolicitud
                            // ❌ QUITAMOS: fecha_solicitud_entrega: new Date().toISOString()
                        })
                        .eq('id', reembolso.id)
                        .select();
                    
                    if (error) {
                        console.error(`Error actualizando ID ${reembolso.id}:`, error);
                        mostrarNotificacion(`Error: ${error.message}`, 'error');
                        return;
                    } else {
                        console.log(`✅ Actualizado ID ${reembolso.id}`);
                    }
                }
                
                const datosEntrega = {
                    ids: reembolsosDelLote.map(r => r.id),
                    reembolsos: reembolsosDelLote,
                    numeroSolicitud: numeroSolicitud,
                    fechaSolicitud: new Date().toISOString(),
                    usuarioSolicitud: currentUser.email,
                    nombreSolicitante: currentUser.nombre,
                    sucursal: reembolsosDelLote[0].sucursal_usuario, // Sucursal del usuario que registró el reembolso
                    totalMonto: totalLote,
                    numeroLote: numeroLote
                };
                
                // GENERAR VENTANA DE IMPRESIÓN
                const ventana = window.open('', '_blank');
                ventana.document.write(generarHTMLParaImprimir(datosEntrega));
                ventana.document.close();
                
                setTimeout(() => {
                    ventana.print();
                }, 500);
                
                mostrarNotificacion(
                    `Solicitud generada para lote ${numeroLote}\n` +
                    `• Número: ${numeroSolicitud}\n` +
                    `• Comprobantes actualizados: ${reembolsosDelLote.length}`,
                    'success'
                );
                
                // RECARGAR DATOS
                setTimeout(async () => {
                    await cargarDatos();
                    cargarGestionEntregas();
                }, 2000);
                
            } catch (error) {
                console.error('Error completo:', error);
                mostrarNotificacion('Error: ' + error.message, 'error');
            }
       
            boton.disabled = false;
        }

        // NUEVA FUNCIÓN: Toggle para mostrar/ocultar detalles del lote
        function toggleLoteDetalle(loteId) {
            const detalle = document.getElementById(`detalle-${loteId}`);
            const icon = document.getElementById(`icon-${loteId}`);
            const texto = document.getElementById(`texto-${loteId}`);
            
            if (detalle.style.display === 'none') {
                detalle.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                texto.textContent = 'Ocultar Detalle';
            } else {
                detalle.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                texto.textContent = 'Ver Detalle';
            }
        }


        function generarEvidenciaEntrega(reembolso) {
            if (!reembolso.evidencia_entrega) {
                return '';
            }
            
            // Convertir a array si no lo es
            let evidencias = [];
            
            if (Array.isArray(reembolso.evidencia_entrega)) {
                evidencias = reembolso.evidencia_entrega;
            } else if (typeof reembolso.evidencia_entrega === 'object') {
                // Si es un objeto, convertirlo a array
                evidencias = [reembolso.evidencia_entrega];
            } else {
                return '';
            }
            
            // Filtrar evidencias válidas
            evidencias = evidencias.filter(e => e && e.url);
            
            if (evidencias.length === 0) {
                return '';
            }
            
            return `
                <div style="margin-bottom: 20px;">
                    <strong>📸 Evidencia de Entrega:</strong>
                    <div style="background: #f0fff4; padding: 15px; border-radius: 8px; border: 1px solid #38a169; margin-top: 10px;">
                        ${evidencias.map(evidencia => `
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                    <div>
                                        <strong>${evidencia.nombre || 'Evidencia de entrega'}</strong><br>
                                        <small style="color: #718096;">
                                            Subido: ${evidencia.fecha_subida ? new Date(evidencia.fecha_subida).toLocaleString('es-MX') : 'Fecha no disponible'}
                                            ${evidencia.usuario_entrega ? ` por ${evidencia.usuario_entrega}` : ''}
                                        </small>
                                    </div>
                                    <a href="${evidencia.url}" target="_blank" class="btn btn-success" style="padding: 6px 12px; font-size: 12px;">
                                        <i class="fas fa-external-link-alt"></i> Ver Comprobante
                                    </a>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // NUEVA FUNCIÓN PARA CARGAR REVISIÓN CON AGRUPACIÓN POR LOTES
        function cargarReembolsosRevision() {
            const container = document.getElementById('reembolsos-revision');
            
            let reembolsosFiltrados = filtrarReembolsosPorUsuario(reembolsos);
            const reembolsosPendientes = reembolsosFiltrados.filter(r => r.estado === 'pendiente');
            const reembolsosEnCorte = reembolsosFiltrados.filter(r => r.estado === 'en_corte');
            const reembolsosAprobados = reembolsosFiltrados.filter(r => r.estado === 'aprobado');
            
            if (reembolsosPendientes.length === 0 && reembolsosEnCorte.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">No hay comprobantes pendientes</p>';
                return;
            }
            
            const totalImagenesPendientes = reembolsosPendientes.reduce((total, reembolso) => {
                return total + (reembolso.archivos ? reembolso.archivos.length : 0);
            }, 0);

            // ✅ MEJORA EL HTML AQUÍ
            container.innerHTML = `
                ${reembolsosPendientes.length > 0 ? `
                    <div style="background: #fef5e7; border: 2px solid #d69e2e; border-radius: 15px; padding: 25px; margin-bottom: 20px;">
                        <h3 style="color: #744210; margin-bottom: 15px;">
                            <i class="fas fa-clock"></i> Listos para Enviar (${reembolsosPendientes.length})
                        </h3>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div><strong>Total:</strong> $${reembolsosPendientes.reduce((sum, r) => sum + parseFloat(r.monto), 0).toLocaleString()}</div>
                                <div><strong>Solicitudes:</strong> ${reembolsosPendientes.length}</div>
                                <div><strong>Comprobantes:</strong> ${totalImagenesPendientes} imágenes</div>
                                <div><strong>Se enviará:</strong> 1 PDF consolidado</div>
                            </div>
                        </div>
                        
                        <!-- TABLA BONITA DE REEMBOLSOS -->
                        <div style="background: white; border-radius: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600;">Beneficiario</th>
                                        <th style="padding: 15px; text-align: left; border-bottom: 2px solid #e9ecef; font-weight: 600;">Concepto</th>
                                        <th style="padding: 15px; text-align: right; border-bottom: 2px solid #e9ecef; font-weight: 600;">Monto</th>
                                        <th style="padding: 15px; text-align: center; border-bottom: 2px solid #e9ecef; font-weight: 600;">Estado</th>
                                        <th style="padding: 15px; text-align: center; border-bottom: 2px solid #e9ecef; font-weight: 600;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reembolsosPendientes.map((r, index) => `
                                        <tr style="border-bottom: 1px solid #e9ecef; ${index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;'}">
                                            <td style="padding: 15px; font-weight: 500;">${r.nombre_beneficiario}</td>
                                            <td style="padding: 15px; color: #666;">${r.concepto}</td>
                                            <td style="padding: 15px; text-align: right; font-weight: 600; color: #2d3748;">$${parseFloat(r.monto).toLocaleString()}</td>
                                            <td style="padding: 15px; text-align: center;">
                                                <span style="background: #fed7d7; color: #c53030; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                                                    ${r.estado}
                                                </span>
                                            </td>
                                            <td style="padding: 15px; text-align: center;">
                                                <button onclick="verDetalles('${r.id}')" style="background: #3182ce; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                    <i class="fas fa-eye"></i> Ver
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="text-align: center;">
                            <button id="btnEnviarAutorizacion" class="btn btn-success" onclick="enviarSolicitudAutorizacion()" style="font-size: 16px; padding: 15px 30px;">
                                <i class="fas fa-paper-plane"></i> Enviar Correo a Fernando
                            </button>
                            <p style="margin-top: 10px; color: #666; font-size: 14px;">
                                Se creará un PDF con ${totalImagenesPendientes} comprobantes y se enviará automáticamente
                            </p>
                        </div>
                    </div>
                ` : ''}
                
                ${reembolsosEnCorte.length > 0 ? `
                    <div style="background: #e6f3ff; border: 2px solid #3182ce; border-radius: 15px; padding: 25px;">
                        <h3 style="color: #2b6cb0; margin-bottom: 15px;">
                            <i class="fas fa-hourglass-half"></i> En Proceso - Esperando Respuesta (${reembolsosEnCorte.length})
                        </h3>
                        <div style="text-align: center;">
                            <button class="btn btn-primary" onclick="recargarDatosCompletos()">
                                <i class="fas fa-sync"></i> Verificar Respuestas
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // FUNCIÓN PARA AGRUPAR POR BENEFICIARIO
        function agruparPorBeneficiario(reembolsos) {
            const grupos = {};
            reembolsos.forEach(reembolso => {
                const beneficiario = reembolso.nombre_beneficiario;
                if (!grupos[beneficiario]) {
                    grupos[beneficiario] = [];
                }
                grupos[beneficiario].push(reembolso);
            });
            return grupos;
        }

        // FUNCIÓN PARA APROBAR TODO EL LOTE
        function aprobarLoteCompleto() {
            mostrarNotificacion('Los reembolsos se procesan automáticamente cuando Fernando responde por correo', 'info');
            mostrarNotificacion('Usa el botón "Enviar Solicitud" para enviar correo a Fernando', 'info');
        }

        function rechazarLoteCompleto() {
            const confirmacion = confirm('¿Rechazar todo el lote manualmente?\n\nEsto solo debe usarse en casos excepcionales.');
            if (!confirmacion) return;
            
            mostrarNotificacion('Para rechazar lotes, normalmente Fernando responde por correo automáticamente', 'warning');
        }

        function mostrarAccionesIndividuales() {
            const container = document.getElementById('acciones-individuales');
            if (container.style.display === 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }


        async function rechazarReembolso(id) {
            const motivo = prompt('Motivo del rechazo:');
            if (!motivo) return;
            
            const reembolso = reembolsos.find(r => r.id === id);
            if (!reembolso) return;
            
            try {
                reembolso.estado = 'rechazado';
                reembolso.progreso = 0;
                reembolso.fechaRechazo = new Date().toISOString();
                reembolso.usuarioRechazo = currentUser.email;
                reembolso.motivoRechazo = motivo;
                
                await actualizarReembolso(reembolso);
                mostrarNotificacion('Reembolso rechazado', 'success');
                cargarReembolsosRevision();
                actualizarDashboard();
                
            } catch (error) {
                mostrarNotificacion('Error rechazando reembolso', 'error');
            }
        }


        // VER DETALLES
        // FUNCIÓN CORREGIDA PARA VER DETALLES
        function verDetalles(id) {
            const reembolso = reembolsos.find(r => r.id === id);
            if (!reembolso) return;
            
            const modal = document.getElementById('modalReembolso');
            const contenido = document.getElementById('contenidoModal');
            
            contenido.innerHTML = `
                <h2><i class="fas fa-file-invoice-dollar"></i> Detalles del Reembolso</h2>
                ${generarHeaderReembolso(reembolso)}
                ${generarInfoBasica(reembolso)}
                ${generarEvidenciaAutomatica(reembolso)}
                ${generarArchivosAdjuntos(reembolso)}
                ${generarEvidenciaEntrega(reembolso)}  <!-- ← Agregar esta línea -->
                ${generarFechasImportantes(reembolso)}
                ${generarMotivoRechazo(reembolso)}
            `;
            
            modal.classList.add('active');
        }


        function generarHeaderReembolso(reembolso) {
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <span class="status-badge status-${reembolso.estado}" style="font-size: 16px;">
                        ${reembolso.estado.toUpperCase()}
                    </span>
                    <div><strong>Progreso:</strong> ${reembolso.progreso}%</div>
                </div>
                
                <div class="progress-bar" style="margin-bottom: 30px;">
                    <div class="progress-fill" style="width: ${reembolso.progreso}%"></div>
                </div>
            `;
        }

        function generarInfoBasica(reembolso) {
            return `
                <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div class="grid">
                        <div><strong>Beneficiario:</strong><br>${reembolso.nombre_beneficiario || 'No especificado'}</div>
                        <div><strong>Monto:</strong><br>$${parseFloat(reembolso.monto || 0).toLocaleString()}</div>
                        <div><strong>Fecha:</strong><br>${new Date(reembolso.fecha + 'T12:00:00').toLocaleDateString()}</div>
                        <div><strong>Autoriza:</strong><br>${reembolso.quien_autoriza || 'No especificado'}</div>
                        <div><strong>Entrega:</strong><br>${reembolso.quien_entrega || 'No especificado'}</div>
                        <div><strong>Registrado por:</strong><br>${reembolso.usuario_registro || 'No especificado'}</div>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                    <h4>Concepto:</h4>
                    <p style="margin: 10px 0; background: #f9f9f9; padding: 15px; border-radius: 8px;">${reembolso.concepto || 'No especificado'}</p>
                </div>
            `;
        }

        function generarEvidenciaAutomatica(reembolso) {
            if (!reembolso.comentarios || !Array.isArray(reembolso.comentarios)) {
                return '';
            }
            
            const comentariosConEvidencia = reembolso.comentarios.filter(c => 
                c.evidenciaCorreo || c.metodo === 'Respuesta Gmail automatica' || c.accion === 'aprobado_por_correo'
            );
            
            if (comentariosConEvidencia.length === 0) return '';
            
            return `
                <div style="margin-bottom: 20px;">
                    <strong>🤖 Procesamiento Automático:</strong>
                    ${comentariosConEvidencia.map(comentario => `
                        <div style="background: #e6fffa; padding: 15px; border-radius: 8px; border-left: 4px solid #38a169; margin-top: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px;">
                                <div>
                                    <strong style="color: #2d3748;">Acción: ${comentario.accion}</strong><br>
                                    <small style="color: #4a5568;">Fecha: ${new Date(comentario.fecha).toLocaleString('es-MX')}</small><br>
                                    <small style="color: #4a5568;">Método: ${comentario.metodo || 'Sistema automático'}</small>
                                </div>
                                ${(comentario.evidenciaCorreo && comentario.evidenciaCorreo.archivoPDF) ? `
                                    <a href="${comentario.evidenciaCorreo.archivoPDF}" target="_blank" class="btn btn-success" style="padding: 8px 12px; font-size: 14px;">
                                        <i class="fas fa-file-pdf"></i> Ver PDF
                                    </a>
                                ` : ''}
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #38a169;">
                                <small style="color: #2d3748;">
                                    <strong>Comentario:</strong> ${comentario.comentario}
                                </small>
                            </div>
                            
                            ${comentario.evidenciaCorreo ? `
                                <div style="background: #f0fff4; padding: 10px; border-radius: 6px; margin-top: 10px; border: 1px solid #68d391;">
                                    <small style="color: #2d3748;">
                                        <strong>📧 Detalles del correo:</strong><br>
                                        <strong>Decisión:</strong> ${comentario.evidenciaCorreo.decision}<br>
                                        <strong>Email:</strong> ${comentario.evidenciaCorreo.emailRemitente}<br>
                                        <strong>Fecha respuesta:</strong> ${new Date(comentario.evidenciaCorreo.fechaRespuesta).toLocaleString('es-MX')}<br>
                                        <strong>Número de corte:</strong> ${comentario.evidenciaCorreo.numeroReembolso}
                                    </small>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generarArchivosAdjuntos(reembolso) {
            const todosLosArchivos = reembolso.archivos || [];
            
            console.log('Total archivos en reembolso:', todosLosArchivos.length);
            console.log('Archivos:', todosLosArchivos);
            
            // Separar por tipoArchivo
            const archivosOriginales = todosLosArchivos.filter(a => {
                if (typeof a === 'string') return true; // URLs viejas son originales
                return !a.tipoArchivo || a.tipoArchivo.startsWith('DOC');
            });
            
            const archivosAdicionales = todosLosArchivos.filter(a => {
                if (typeof a === 'string') return false;
                return a.tipoArchivo && a.tipoArchivo.startsWith('ADD');
            });
            
            console.log('Originales:', archivosOriginales.length);
            console.log('Adicionales:', archivosAdicionales.length);
            
            let html = '';
            
            // ARCHIVOS ORIGINALES
            if (archivosOriginales.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <strong>📎 Comprobantes originales (${archivosOriginales.length}):</strong>
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 10px;">
                            ${archivosOriginales.map((archivo, index) => {
                                let archivoUrl, nombreArchivo;
                                
                                if (typeof archivo === 'string') {
                                    archivoUrl = archivo;
                                    nombreArchivo = archivo.split('/').pop() || `Archivo ${index + 1}`;
                                } else {
                                    archivoUrl = archivo.url;
                                    nombreArchivo = archivo.nombreOriginal || archivo.nombre || `Archivo ${index + 1}`;
                                }
                                
                                return `
                                    <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <i class="fas fa-file-image" style="color: #667eea;"></i>
                                            <span><strong>${nombreArchivo}</strong></span>
                                        </div>
                                        <a href="${archivoUrl}" target="_blank" class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;">
                                            <i class="fas fa-external-link-alt"></i> Ver
                                        </a>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            // ARCHIVOS ADICIONALES
            if (archivosAdicionales.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <strong>➕ Archivos adicionales (${archivosAdicionales.length}):</strong>
                        <div style="background: #f0fff4; padding: 15px; border-radius: 8px; border: 1px solid #38a169; margin-top: 10px;">
                            ${archivosAdicionales.map(archivo => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #c6f6d5; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-file-plus" style="color: #38a169;"></i>
                                        <div>
                                            <strong>${archivo.nombreOriginal || archivo.nombre}</strong><br>
                                            <small style="color: #718096;">
                                                ${archivo.fechaSubida ? `Agregado: ${new Date(archivo.fechaSubida + 'T12:00:00').toLocaleString('es-MX')}` : ''}
                                                ${archivo.usuarioSubida ? ` por ${archivo.usuarioSubida}` : ''}
                                            </small>
                                        </div>
                                    </div>
                                    <a href="${archivo.url}" target="_blank" class="btn btn-success" style="padding: 4px 8px; font-size: 12px;">
                                        <i class="fas fa-external-link-alt"></i> Ver
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (archivosOriginales.length === 0 && archivosAdicionales.length === 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <strong>📎 Archivos adjuntos:</strong>
                        <p style="color: #718096; font-style: italic; margin-top: 5px;">No hay archivos adjuntos</p>
                    </div>
                `;
            }
            
            return html;
        }
        function generarFechasImportantes(reembolso) {
            const fechas = [];
            
            if (reembolso.fechaRegistro) {
                fechas.push(`<li><strong>Registro:</strong> ${new Date(reembolso.fechaRegistro + 'T12:00:00').toLocaleString()}</li>`);
            }
            if (reembolso.fechaAprobacion) {
                fechas.push(`<li><strong>Aprobación:</strong> ${new Date(reembolso.fechaAprobacion + 'T12:00:00').toLocaleString()}</li>`); 
            }
            if (reembolso.fechaRechazo) {
                fechas.push(`<li><strong>Rechazo:</strong> ${new Date(reembolso.fechaRechazo + 'T12:00:00').toLocaleString()}</li>`);
            }
            if (reembolso.fechaEntrega) {
                fechas.push(`<li><strong>Entrega:</strong> ${new Date(reembolso.fechaEntrega + 'T12:00:00').toLocaleString()}</li>`);
            }
            
            if (fechas.length === 0) return '';
            
            return `
                <div style="margin-bottom: 20px;">
                    <strong>📅 Fechas importantes:</strong><br>
                    <ul style="margin: 10px 0;">
                        ${fechas.join('')}
                    </ul>
                </div>
            `;
        }

        function generarMotivoRechazo(reembolso) {
            if (!reembolso.motivoRechazo) return '';
            
            return `
                <div style="background: #fed7d7; padding: 15px; border-radius: 8px; border-left: 4px solid #e53e3e;">
                    <strong>❌ Motivo del rechazo:</strong><br>
                    ${reembolso.motivoRechazo}
                </div>
            `;
        }

        function cerrarModal() {
            document.getElementById('modalReembolso').classList.remove('active');
        }

        // DASHBOARD
        function actualizarDashboard() {
            if (!reembolsos) return;
            
            const total = reembolsos.length;
            const montoTotal = reembolsos.reduce((sum, r) => sum + parseFloat(r.monto || 0), 0);
            const pendientes = reembolsos.filter(r => r.estado === 'pendiente').length;
            const entregadosHoy = reembolsos.filter(r => {
                const hoy = new Date().toDateString();
                const fechaReembolso = new Date(r.created_at || r.fecha_registro).toDateString();
                return r.estado === 'entregado' && fechaReembolso === hoy;
            }).length;
            
            // Actualizar con los IDs correctos
            document.getElementById('totalReembolsos').textContent = total;
            document.getElementById('montoTotal').textContent = `$${montoTotal.toLocaleString()}`;
            document.getElementById('pendientesRevision').textContent = pendientes;
            document.getElementById('entregadosHoy').textContent = entregadosHoy;
            
            console.log('Dashboard actualizado:', { total, montoTotal, pendientes, entregadosHoy });
        }


        // REPORTES
        function generarReporte() {
            const fechaDesdeEl = document.getElementById('fechaDesde');
            const fechaHastaEl = document.getElementById('fechaHasta');
            const estadoFiltroEl = document.getElementById('filtroEstado');
            const beneficiarioFiltroEl = document.getElementById('filtroBeneficiario');
            const sucursalFiltroEl = document.getElementById('filtroSucursal');
            const quienEntregaFiltroEl = document.getElementById('filtroQuienEntrega');
            const loteFiltroEl = document.getElementById('filtroLote');

            const fechaDesde = fechaDesdeEl ? fechaDesdeEl.value : '';
            const fechaHasta = fechaHastaEl ? fechaHastaEl.value : '';
            const estadoFiltro = estadoFiltroEl ? estadoFiltroEl.value : '';
            const beneficiarioFiltro = beneficiarioFiltroEl ? beneficiarioFiltroEl.value.toLowerCase() : '';
            const sucursalFiltro = sucursalFiltroEl ? sucursalFiltroEl.value : '';
            const quienEntregaFiltro = quienEntregaFiltroEl ? quienEntregaFiltroEl.value : '';
            const loteFiltro = loteFiltroEl ? loteFiltroEl.value.toLowerCase().trim() : '';

            let reembolsosFiltrados = [...reembolsos];
            
            // Filtrar por usuario si no es admin/administracion
            if (currentUser.rol !== 'admin' && currentUser.rol !== 'administracion') {
                reembolsosFiltrados = reembolsosFiltrados.filter(r => 
                    r.usuario_registro === currentUser.email
                );
            }
            
            // Aplicar todos los filtros
            if (fechaDesde) {
                reembolsosFiltrados = reembolsosFiltrados.filter(r => r.fecha >= fechaDesde);
            }
            if (fechaHasta) {
                reembolsosFiltrados = reembolsosFiltrados.filter(r => r.fecha <= fechaHasta);
            }
            if (estadoFiltro) {
                reembolsosFiltrados = reembolsosFiltrados.filter(r => r.estado === estadoFiltro);
            }
            if (beneficiarioFiltro) {
                reembolsosFiltrados = reembolsosFiltrados.filter(r => 
                    r.nombre_beneficiario.toLowerCase().includes(beneficiarioFiltro)
                );
            }
            if (sucursalFiltro) {
                reembolsosFiltrados = reembolsosFiltrados.filter(r => 
                    r.sucursal_usuario === sucursalFiltro
                );
            }
            if (quienEntregaFiltro) {
                reembolsosFiltrados = reembolsosFiltrados.filter(r =>
                    r.quien_entrega === quienEntregaFiltro
                );
            }
            if (loteFiltro) {
                reembolsosFiltrados = reembolsosFiltrados.filter(r =>
                    r.numero_lote && r.numero_lote.toLowerCase().includes(loteFiltro)
                );
            }

            // ✅ GUARDAR en variable global
            reembolsosFiltradosGlobal = reembolsosFiltrados;
            
            console.log('Reembolsos filtrados:', reembolsosFiltradosGlobal.length); // ✅ LOG para verificar
            
            const container = document.getElementById('tablaReportes');
            
            if (reembolsosFiltrados.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">No se encontraron reembolsos con los filtros aplicados</p>';
                return;
            }
            
            // Agregar botones de vista
            container.innerHTML = `
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <button class="btn btn-primary" onclick="mostrarVistaTabla()" id="btnVistaTabla">
                        <i class="fas fa-table"></i> Vista Tabla
                    </button>
                    <button class="btn btn-secondary" onclick="mostrarVistaLotes()" id="btnVistaLotes">
                        <i class="fas fa-layer-group"></i> Vista por Lotes
                    </button>
                </div>
                
                <div id="contenidoReporte"></div>
            `;
            
            // Mostrar vista tabla por defecto
            mostrarVistaTabla();
        }

        // FUNCIÓN para llenar el filtro de "Quien Entrega" dinámicamente
        function cargarFiltroQuienEntrega() {
            const select = document.getElementById('filtroQuienEntrega');
            if (!select) return;
            
            // Obtener todos los valores únicos de quien_entrega
            const quienEntregaSet = new Set();
            
            reembolsos.forEach(reembolso => {
                if (reembolso.quien_entrega && reembolso.quien_entrega.trim() !== '') {
                    quienEntregaSet.add(reembolso.quien_entrega.trim());
                }
            });
            
            // Convertir a array y ordenar
            const quienEntregaArray = Array.from(quienEntregaSet).sort();
            
            // Limpiar opciones existentes (excepto "Todos")
            select.innerHTML = '<option value="">Todos</option>';
            
            // Agregar opciones dinámicas
            quienEntregaArray.forEach(persona => {
                const option = document.createElement('option');
                option.value = persona;
                option.textContent = persona;
                select.appendChild(option);
            });
            
            console.log('Filtro Quien Entrega cargado con:', quienEntregaArray);
        }

        function mostrarVistaTabla() {
            const reembolsosFiltrados = obtenerReembolsosFiltrados();
            const container = document.getElementById('contenidoReporte');
            
            // Actualizar botones
            document.getElementById('btnVistaTabla').className = 'btn btn-primary';
            document.getElementById('btnVistaLotes').className = 'btn btn-secondary';
            
            container.innerHTML = `
                <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="background: #f8f9fa; padding: 15px; border-bottom: 2px solid #e9ecef;">
                        <h4 style="margin: 0; color: #2d3748;">Reporte de Reembolsos (${reembolsosFiltrados.length} registros)</h4>
                        <p style="margin: 5px 0 0 0; color: #666;">Total: $${reembolsosFiltrados.reduce((sum, r) => sum + parseFloat(r.monto), 0).toLocaleString()}</p>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; min-width: 1400px;">
                            <thead style="background: #f1f3f4; position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; min-width: 150px;">Beneficiario</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e9ecef; min-width: 100px;">Fecha</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid #e9ecef; min-width: 80px;">Monto</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; min-width: 200px;">Concepto</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e9ecef; min-width: 100px;">Estado</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e9ecef; min-width: 80px;">Sucursal</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e9ecef; min-width: 100px;">Lote</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e9ecef; min-width: 120px;">Archivos</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #e9ecef; min-width: 100px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reembolsosFiltrados.map((r, index) => `
                                    <tr style="border-bottom: 1px solid #e9ecef; ${index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;'}">
                                        <td style="padding: 12px; font-weight: 500;">${r.nombre_beneficiario || ''}</td>
                                        <td style="padding: 12px; text-align: center;">${r.fecha ? new Date(r.fecha + 'T12:00:00').toLocaleDateString('es-MX') : 'N/A'}</td>
                                        <td style="padding: 12px; text-align: right; font-weight: 600;">$${parseFloat(r.monto || 0).toLocaleString()}</td>
                                        <td style="padding: 12px; max-width: 200px; word-wrap: break-word;">${r.concepto || 'N/A'}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <span style="background: ${getEstadoColor(r.estado).bg}; 
                                                        color: ${getEstadoColor(r.estado).text}; 
                                                        padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                                ${(r.estado || 'PENDIENTE').toUpperCase()}
                                            </span>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: bold;">
                                                ${r.sucursal_usuario || 'N/A'}
                                            </span>
                                        </td>
                                        <td style="padding: 12px; text-align: center; font-size: 11px;">${r.numero_lote || 'N/A'}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            ${(r.archivos && r.archivos.length > 0) ? `
                                                <button class="btn btn-info" onclick="verArchivosReembolso('${r.id}')" style="padding: 4px 8px; font-size: 12px;">
                                                    <i class="fas fa-paperclip"></i> ${r.archivos.length}
                                                </button>
                                            ` : `
                                                <span style="color: #999; font-size: 12px;">Sin archivos</span>
                                            `}
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button class="btn btn-primary" onclick="verDetalles('${r.id}')" style="padding: 4px 8px; font-size: 12px;">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function mostrarVistaLotes() {
            const reembolsosFiltrados = obtenerReembolsosFiltrados();
            const container = document.getElementById('contenidoReporte');
            
            // Actualizar botones
            document.getElementById('btnVistaTabla').className = 'btn btn-secondary';
            document.getElementById('btnVistaLotes').className = 'btn btn-primary';
            
            // Agrupar por lote
            const lotes = {};
            const sinLote = [];
            
            reembolsosFiltrados.forEach(reembolso => {
                const lote = reembolso.numero_lote;
                if (lote && lote !== 'N/A') {
                    if (!lotes[lote]) {
                        lotes[lote] = [];
                    }
                    lotes[lote].push(reembolso);
                } else {
                    sinLote.push(reembolso);
                }
            });
            
            let html = '<div>';
            
            // Mostrar lotes agrupados
            Object.keys(lotes).sort().reverse().forEach(numeroLote => {
                const reembolsosLote = lotes[numeroLote];
                const totalLote = reembolsosLote.reduce((sum, r) => sum + parseFloat(r.monto), 0);
                const estadoLote = reembolsosLote[0].estado;
                const sucursal = reembolsosLote[0].sucursal_usuario;
                
                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 5px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <h3 style="margin: 0; color: #1a365d;">
                                    <i class="fas fa-layer-group"></i> ${numeroLote}
                                </h3>
                                <div style="display: flex; gap: 15px; margin-top: 8px; align-items: center; flex-wrap: wrap;">
                                    <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: bold;">
                                        ${sucursal}
                                    </span>
                                    <span class="status-badge status-${estadoLote}" style="font-size: 13px;">
                                        ${estadoLote.toUpperCase()}
                                    </span>
                                    <span style="color: #4a5568; font-size: 14px;">
                                        <strong>${reembolsosLote.length}</strong> reembolsos
                                    </span>
                                    <span style="color: #1a365d; font-size: 16px; font-weight: bold;">
                                        Total: $${totalLote.toLocaleString()}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button class="btn btn-primary" onclick="toggleDetalleLote('${sanitizarIdLote(numeroLote)}')" style="padding: 8px 16px; font-size: 14px;">
                                    <i class="fas fa-chevron-down" id="icon-${sanitizarIdLote(numeroLote)}"></i>
                                    <span id="texto-${sanitizarIdLote(numeroLote)}">Ver Detalle</span>
                                </button>
                            </div>
                        </div>

                        <div id="detalle-${sanitizarIdLote(numeroLote)}" style="display: none; margin-top: 15px; border-top: 2px solid #e2e8f0; padding-top: 15px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f7fafc;">
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Beneficiario</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Concepto</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e2e8f0;">Monto</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e2e8f0;">Archivos</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e2e8f0;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reembolsosLote.map(r => `
                                        <tr style="border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 10px;">${r.nombre_beneficiario}</td>
                                            <td style="padding: 10px; max-width: 200px; word-wrap: break-word;">${r.concepto}</td>
                                            <td style="padding: 10px; text-align: right; font-weight: bold;">$${parseFloat(r.monto).toLocaleString()}</td>
                                            <td style="padding: 10px; text-align: center;">
                                                ${(r.archivos && r.archivos.length > 0) ? `
                                                    <button class="btn btn-info" onclick="verArchivosReembolso('${r.id}')" style="padding: 4px 8px; font-size: 12px;">
                                                        <i class="fas fa-paperclip"></i> ${r.archivos.length}
                                                    </button>
                                                ` : `
                                                    <span style="color: #999; font-size: 12px;">Sin archivos</span>
                                                `}
                                            </td>
                                            <td style="padding: 10px; text-align: center;">
                                                <button class="btn btn-primary" onclick="verDetalles('${r.id}')" style="padding: 6px 12px; font-size: 13px; margin-right: 5px;">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            // Reembolsos sin lote
            if (sinLote.length > 0) {
                html += `
                    <div style="background: #fef5e7; border-radius: 12px; padding: 20px; margin-top: 20px; border-left: 5px solid #d69e2e;">
                        <h3 style="color: #744210; margin-bottom: 15px;">
                            <i class="fas fa-exclamation-triangle"></i> Reembolsos sin lote (${sinLote.length})
                        </h3>
                        
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background: #744210; color: white;">
                                    <th style="padding: 12px; text-align: left;">Beneficiario</th>
                                    <th style="padding: 12px; text-align: left;">Concepto</th>
                                    <th style="padding: 12px; text-align: right;">Monto</th>
                                    <th style="padding: 12px; text-align: center;">Archivos</th>
                                    <th style="padding: 12px; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sinLote.map(reembolso => `
                                    <tr style="border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 12px;">${reembolso.nombre_beneficiario}</td>
                                        <td style="padding: 12px; max-width: 200px; word-wrap: break-word;">${reembolso.concepto}</td>
                                        <td style="padding: 12px; text-align: right; font-weight: bold;">$${parseFloat(reembolso.monto).toLocaleString()}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            ${(reembolso.archivos && reembolso.archivos.length > 0) ? `
                                                <button class="btn btn-info" onclick="verArchivosReembolso('${reembolso.id}')" style="padding: 4px 8px; font-size: 12px;">
                                                    <i class="fas fa-paperclip"></i> ${reembolso.archivos.length}
                                                </button>
                                            ` : `
                                                <span style="color: #999; font-size: 12px;">Sin archivos</span>
                                            `}
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button class="btn btn-primary" onclick="verDetalles('${reembolso.id}')" style="padding: 6px 12px; font-size: 13px;">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function toggleDetalleLote(idSanitizado) {
            const detalleId = `detalle-${idSanitizado}`;
            const iconoId = `icon-${idSanitizado}`;
            const textoId = `texto-${idSanitizado}`;

            const detalle = document.getElementById(detalleId);
            const icono = document.getElementById(iconoId);
            const texto = document.getElementById(textoId);

            if (!detalle) {
                console.error('❌ Error: No se encontró el elemento detalle con ID:', detalleId);
                console.warn('IDs buscados:', { detalleId, iconoId, textoId });
                // Intentar mostrar todos los IDs disponibles para debug
                const todosLosDetalle = document.querySelectorAll('[id^="detalle-"]');
                console.log('IDs disponibles:', Array.from(todosLosDetalle).map(el => el.id));
                return;
            }

            if (!icono || !texto) {
                console.warn('⚠️ Advertencia: No se encontraron icono o texto para:', idSanitizado);
            }

            const estaOculto = detalle.style.display === 'none' || detalle.style.display === '';

            if (estaOculto) {
                detalle.style.display = 'block';
                if (icono) icono.className = 'fas fa-chevron-up';
                if (texto) texto.textContent = 'Ocultar Detalle';
            } else {
                detalle.style.display = 'none';
                if (icono) icono.className = 'fas fa-chevron-down';
                if (texto) texto.textContent = 'Ver Detalle';
            }
        }

        function verArchivosReembolso(id) {
            const reembolso = reembolsos.find(r => r.id == id);
            if (!reembolso || !reembolso.archivos || reembolso.archivos.length === 0) {
                mostrarNotificacion('Este reembolso no tiene archivos adjuntos', 'warning');
                return;
            }
            
            const modal = document.getElementById('modalReembolso');
            const contenido = document.getElementById('contenidoModal');
            
            contenido.innerHTML = `
                <h2><i class="fas fa-paperclip"></i> Archivos Adjuntos</h2>
                <h3>${reembolso.nombre_beneficiario} - $${parseFloat(reembolso.monto).toLocaleString()}</h3>
                
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <p><strong>Concepto:</strong> ${reembolso.concepto}</p>
                    <p><strong>Fecha:</strong> ${new Date(reembolso.fecha + 'T12:00:00').toLocaleDateString('es-MX')}</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Archivos (${reembolso.archivos.length}):</h4>
                    <div style="display: grid; gap: 10px; margin-top: 15px;">
                        ${reembolso.archivos.map((archivo, index) => {
                            let archivoUrl, nombreArchivo;
                            
                            if (typeof archivo === 'string') {
                                archivoUrl = archivo;
                                nombreArchivo = archivo.split('/').pop() || `Archivo ${index + 1}`;
                            } else {
                                archivoUrl = archivo.url;
                                nombreArchivo = archivo.nombre || archivo.nombreOriginal || `Archivo ${index + 1}`;
                            }
                            
                            return `
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <i class="fas fa-file-image" style="color: #667eea; font-size: 20px;"></i>
                                        <div>
                                            <strong>${nombreArchivo}</strong>
                                            ${archivo.fechaSubida ? `<br><small style="color: #666;">Subido: ${new Date(archivo.fechaSubida).toLocaleDateString('es-MX')}</small>` : ''}
                                        </div>
                                    </div>
                                    <a href="${archivoUrl}" target="_blank" class="btn btn-primary" style="padding: 8px 16px;">
                                        <i class="fas fa-external-link-alt"></i> Ver Archivo
                                    </a>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="cerrarModal()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
        }


        // ✅ FUNCIÓN AUXILIAR PARA COLORES DE ESTADOS
        function getEstadoColor(estado) {
            const colores = {
                'pendiente': { bg: '#fed7d7', text: '#c53030' },
                'en_corte': { bg: '#bee3f8', text: '#2b6cb0' },
                'aprobado': { bg: '#c6f6d5', text: '#2f855a' },
                'rechazado': { bg: '#fed7d7', text: '#c53030' },
                'solicitado_entrega': { bg: '#faf089', text: '#744210' },
                'entregado': { bg: '#c6f6d5', text: '#2f855a' }
            };
            
            return colores[estado] || { bg: '#e2e8f0', text: '#4a5568' };
        }

        function generarVistaAgrupadaPorLotes(reembolsosFiltrados, container) {
            // Agrupar por número de corte
            const lotes = {};
            const sinLote = [];
            
            reembolsosFiltrados.forEach(reembolso => {
                const comentarios = reembolso.comentarios || [];
                
                // BUSCAR EN 2 LUGARES:
                // 1. En comentarios nuevos (numeroCorte)
                const corteEncontrado = comentarios.find(c => c.numeroCorte);
                let numeroCorte = corteEncontrado ? corteEncontrado.numeroCorte : null;
                
                // 2. En comentarios viejos (evidenciaCorreo.numeroReembolso)
                if (!numeroCorte) {
                    const comentarioAprobacion = comentarios.find(c => 
                        c.accion === 'aprobado_por_correo' && 
                        c.evidenciaCorreo && 
                        c.evidenciaCorreo.numeroReembolso
                    );
                    
                    if (comentarioAprobacion) {
                        numeroCorte = comentarioAprobacion.evidenciaCorreo.numeroReembolso;
                    }
                }
                
                if (numeroCorte) {
                    if (!lotes[numeroCorte]) {
                        lotes[numeroCorte] = [];
                    }
                    lotes[numeroCorte].push(reembolso);
                } else {
                    sinLote.push(reembolso);
                }
            });
            
            const nombresSucursales = {
                'LMM': 'Los Mochis',
                'JJR': 'Juan José Ríos', 
                'CLN': 'Culiacán',
                'FTE': 'El Fuerte',
                'SJC': 'San José del Cabo',
                'CSL': 'Cabo San Lucas',
                'TML': 'Tamaral',
                'LPZ': 'La Paz'
            };
            
            let html = '<div>';
            
            // Mostrar lotes agrupados
            Object.keys(lotes).sort().reverse().forEach(numeroCorte => {
                const reembolsosLote = lotes[numeroCorte];
                const totalLote = reembolsosLote.reduce((sum, r) => sum + parseFloat(r.monto), 0);
                const primerReembolso = reembolsosLote[0];
                const estadoLote = primerReembolso.estado;
                const sucursal = primerReembolso.sucursal_usuario;
                
                // Obtener archivos del lote
                const archivosLote = primerReembolso.documentosAdicionales || [];
                
                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 5px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <h3 style="margin: 0; color: #1a365d;">
                                    <i class="fas fa-layer-group"></i> ${numeroCorte}
                                </h3>
                                <div style="display: flex; gap: 15px; margin-top: 8px; align-items: center; flex-wrap: wrap;">
                                    <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: bold;">
                                        ${sucursal} - ${nombresSucursales[sucursal] || 'Sin sucursal'}
                                    </span>
                                    <span class="status-badge status-${estadoLote}" style="font-size: 13px;">
                                        ${estadoLote.toUpperCase()}
                                    </span>
                                    <span style="color: #4a5568; font-size: 14px;">
                                        <strong>${reembolsosLote.length}</strong> reembolsos
                                    </span>
                                    <span style="color: #1a365d; font-size: 16px; font-weight: bold;">
                                        Total: $${totalLote.toLocaleString()}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button class="btn btn-primary" onclick="toggleLote('${numeroCorte.replace(/[^a-zA-Z0-9]/g, '_')}')" style="padding: 8px 16px; font-size: 14px;">
                                    <i class="fas fa-chevron-down" id="icon-${numeroCorte.replace(/[^a-zA-Z0-9]/g, '_')}"></i> 
                                    <span id="texto-${numeroCorte.replace(/[^a-zA-Z0-9]/g, '_')}">Ver Detalle</span>
                                </button>
                            </div>
                        </div>
                        
                        ${archivosLote.filter(a => a.esDocumentoLote).length > 0 ? `
                            <div style="background: #f0fff4; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #38a169;">
                                <strong style="color: #2f855a;">📎 Archivos del lote:</strong>
                                <div style="margin-top: 8px;">
                                    ${archivosLote.filter(a => a.esDocumentoLote).map(archivo => `
                                        <div style="display: inline-block; margin: 4px; background: white; padding: 6px 12px; border-radius: 6px; border: 1px solid #38a169;">
                                            <i class="fas fa-file"></i>
                                            <a href="${archivo.url}" target="_blank" style="color: #2f855a; text-decoration: none; margin-left: 5px;">
                                                ${archivo.nombre}
                                            </a>
                                            <small style="color: #718096; margin-left: 8px;">${new Date(archivo.fechaSubida).toLocaleDateString()}</small>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div id="detalle-${numeroCorte.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none; margin-top: 15px; border-top: 2px solid #e2e8f0; padding-top: 15px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f7fafc;">
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Beneficiario</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Fecha</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e2e8f0;">Monto</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0;">Autoriza</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e2e8f0;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reembolsosLote.map(r => `
                                        <tr style="border-bottom: 1px solid #e2e8f0;">
                                            <td style="padding: 10px;">${r.nombre_beneficiario}</td>
                                            <td style="padding: 10px;">${new Date(r.fecha).toLocaleDateString()}</td>
                                            <td style="padding: 10px; text-align: right; font-weight: bold;">$${parseFloat(r.monto).toLocaleString()}</td>
                                            <td style="padding: 10px;">${r.quien_autoriza}</td>
                                            <td style="padding: 10px; text-align: center;">
                                                <button class="btn btn-primary" onclick="verDetalles(${r.id})" style="padding: 6px 12px; font-size: 13px; margin-right: 5px;">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-warning" onclick="editarReembolso(${r.id})" style="padding: 6px 12px; font-size: 13px;">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });
            
            // Reembolsos sin lote
            // Reembolsos sin lote
            if (sinLote.length > 0) {
                html += `
                    <div style="background: #fef5e7; border-radius: 12px; padding: 20px; margin-top: 20px; border-left: 5px solid #d69e2e;">
                        <h3 style="color: #744210; margin-bottom: 15px;">
                            <i class="fas fa-exclamation-triangle"></i> Reembolsos sin lote (${sinLote.length})
                        </h3>
                        
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background: #744210; color: white;">
                                    <th style="padding: 12px; text-align: left;">Sucursal</th>
                                    <th style="padding: 12px; text-align: left;">Beneficiario</th>
                                    <th style="padding: 12px; text-align: left;">Fecha</th>
                                    <th style="padding: 12px; text-align: right;">Monto</th>
                                    <th style="padding: 12px; text-align: left;">Autoriza</th>
                                    <th style="padding: 12px; text-align: left;">Estado</th>
                                    <th style="padding: 12px; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sinLote.map(reembolso => `
                                    <tr style="border-bottom: 1px solid #e2e8f0;">
                                        <td style="padding: 12px;">
                                            <span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                                ${reembolso.sucursal_usuario || 'N/A'}
                                            </span>
                                        </td>
                                        <td style="padding: 12px;">${reembolso.nombre_beneficiario}</td>
                                        <td style="padding: 12px;">${new Date(reembolso.fecha).toLocaleDateString()}</td>
                                        <td style="padding: 12px; text-align: right; font-weight: bold;">$${parseFloat(reembolso.monto).toLocaleString()}</td>
                                        <td style="padding: 12px;">${reembolso.quien_autoriza}</td>
                                        <td style="padding: 12px;">
                                            <span class="status-badge status-${reembolso.estado}">
                                                ${reembolso.estado.toUpperCase()}
                                            </span>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <button class="btn btn-primary" onclick="verDetalles(${reembolso.id})" style="padding: 6px 12px; font-size: 13px;">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            html += '</div>';

            container.innerHTML = html;
        }

        function generarTablaNormal(reembolsosFiltrados, container, htmlPrevio = '') {
            const nombresSucursales = {
                'LMM': 'Los Mochis',
                'JJR': 'Juan José Ríos', 
                'CLN': 'Culiacán',
                'FTE': 'El Fuerte',
                'SJC': 'San José del Cabo',
                'CSL': 'Cabo San Lucas',
                'TML': 'Tamaral',
                'LPZ': 'La Paz'
            };
            
            const html = htmlPrevio + `
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                            <th style="padding: 15px; text-align: left;">Sucursal</th>
                            <th style="padding: 15px; text-align: left;">Beneficiario</th>
                            <th style="padding: 15px; text-align: left;">Fecha</th>
                            <th style="padding: 15px; text-align: left;">Monto</th>
                            <th style="padding: 15px; text-align: left;">Autoriza</th>
                            <th style="padding: 15px; text-align: left;">Estado</th>
                            <th style="padding: 15px; text-align: left;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${reembolsosFiltrados.map(reembolso => {
                            // Detectar si tiene archivos adicionales (fichas de pago)
                            const todosLosArchivos = reembolso.archivos || [];
                            // LOGS DE DEBUG
                            console.log('Reembolso:', reembolso.nombre_beneficiario);
                            console.log('Total archivos:', todosLosArchivos.length);
                            console.log('Archivos:', todosLosArchivos);

                            const tieneAdicionales = todosLosArchivos.some(a => {
                            console.log('Revisando archivo:', a);
                            console.log('Es string?', typeof a === 'string');
                            console.log('tipoArchivo:', a.tipoArchivo);
                            console.log('Empieza con ADD?', a.tipoArchivo && a.tipoArchivo.startsWith('ADD'));

                                if (typeof a === 'string') return false;
                                return a.tipoArchivo && a.tipoArchivo.startsWith('ADD');
                            });
                            console.log('¿Tiene adicionales?', tieneAdicionales);
                            console.log('---');


                            
                            return `
                                <tr style="border-bottom: 1px solid #e2e8f0;" onmouseover="this.style.background='rgba(102, 126, 234, 0.05)'" onmouseout="this.style.background='white'">
                                    <td style="padding: 15px;">
                                        <span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                            ${reembolso.sucursal_usuario || 'N/A'}
                                        </span><br>
                                        <small style="color: #718096;">${nombresSucursales[reembolso.sucursal_usuario] || 'Sin sucursal'}</small>
                                    </td>
                                    <td style="padding: 15px;">
                                        ${reembolso.nombre_beneficiario}
                                        ${tieneAdicionales ? `
                                            <br>
                                            <span style="display: inline-flex; align-items: center; gap: 4px; background: #f0fff4; color: #2f855a; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-top: 4px; border: 1px solid #38a169;">
                                                <i class="fas fa-file-invoice" style="font-size: 10px;"></i>
                                                Fichas de pago
                                            </span>
                                        ` : ''}
                                    </td>
                                    <td style="padding: 15px;">${new Date(reembolso.fecha).toLocaleDateString()}</td>
                                    <td style="padding: 15px;">$${parseFloat(reembolso.monto).toLocaleString()}</td>
                                    <td style="padding: 15px;">${reembolso.quienAutoriza}</td>
                                    <td style="padding: 15px;">
                                        <span class="status-badge status-${reembolso.estado}">
                                            ${reembolso.estado.toUpperCase()}
                                        </span>
                                    </td>
                                    <td style="padding: 15px;">
                                        <button class="btn btn-primary" onclick="verDetalles(${reembolso.id})" style="padding: 8px 12px; font-size: 14px;">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                    <h4>Resumen del Reporte</h4>
                    <div class="grid" style="margin-top: 15px;">
                        <div><strong>Total de comprobantes:</strong> ${reembolsosFiltrados.length}</div>
                        <div><strong>Monto total:</strong> $${reembolsosFiltrados.reduce((sum, r) => sum + parseFloat(r.monto || 0), 0).toLocaleString()}</div>
                        <div><strong>Aprobados:</strong> ${reembolsosFiltrados.filter(r => r.estado === 'aprobado').length}</div>
                        <div><strong>Pendientes:</strong> ${reembolsosFiltrados.filter(r => r.estado === 'pendiente').length}</div>
                    </div>
                </div>
            `;
            
            if (container) {
                container.innerHTML = html;
            } else {
                return html;
            }
        }



        function toggleLote(numeroCorte) {
            const detalle = document.getElementById(`detalle-${numeroCorte}`);
            const icono = document.getElementById(`icon-${numeroCorte}`);
            const texto = document.getElementById(`texto-${numeroCorte}`);
            
            if (detalle.style.display === 'none') {
                detalle.style.display = 'block';
                icono.className = 'fas fa-chevron-up';
                texto.textContent = 'Ocultar Detalle';
            } else {
                detalle.style.display = 'none';
                icono.className = 'fas fa-chevron-down';
                texto.textContent = 'Ver Detalle';
            }
        }

        async function agregarArchivoLote(numeroCorte) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,application/pdf';
            input.multiple = true;
            
            input.onchange = async function(e) {
                const archivos = Array.from(e.target.files);
                if (archivos.length === 0) return;
                
                try {
                    mostrarNotificacion('Subiendo archivos...', 'info');
                    
                    let archivosBase64 = [];
                    for (const archivo of archivos) {
                        const base64 = await convertirArchivoABase64(archivo);
                        archivosBase64.push({
                            nombre: archivo.name,
                            tipo: archivo.type,
                            tamaño: archivo.size,
                            base64: base64
                        });
                    }
                    
                    // Usar insertReembolso que YA FUNCIONA
                    const data = {
                        esArchivoLote: true,  // FLAG para detectarlo
                        numeroLote: numeroCorte,
                        archivos: archivosBase64,
                       usuario_registro: currentUser.email,
                        nombreBeneficiario: 'LOTE_' + numeroCorte  // Requerido
                    };
                    
                    const response = await enviarReembolso(data);
                    
                    if (response.success) {
                        mostrarNotificacion(`Archivos agregados (${response.actualizados} reembolsos)`, 'success');
                        await cargarDatos();
                        generarReporte();
                    }
                    
                } catch (error) {
                    mostrarNotificacion('Error: ' + error.message, 'error');
                }
            };
            
            input.click();
        }

        async function enviarArchivosLote(datos) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = GOOGLE_SCRIPT_URL;
            form.target = 'hidden-iframe-lote';
            form.style.display = 'none';
            
            const iframe = document.createElement('iframe');
            iframe.name = 'hidden-iframe-lote';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            const payload = {
                action: 'AGREGAR_ARCHIVOS_LOTE',
                data: datos
            };
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'postData';
            input.value = JSON.stringify(payload);
            form.appendChild(input);
            
            document.body.appendChild(form);
            form.submit();
            
            return new Promise(resolve => {
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                    resolve({ success: true });
                }, 4000);
            });
        }



                    function exportarExcel() {
                        const reembolsosFiltrados = obtenerReembolsosFiltrados();
                        
                        if (reembolsosFiltrados.length === 0) {
                            mostrarNotificacion('No hay datos para exportar', 'error');
                            return;
                        }
                        
                        // ✅ TODAS LAS COLUMNAS EN EXCEL
                        const datosExcel = reembolsosFiltrados.map(r => ({
                            'Beneficiario': r.nombre_beneficiario || '',
                            'Fecha': r.fecha ? new Date(r.fecha).toLocaleDateString('es-MX') : '',
                            'Monto': parseFloat(r.monto || 0),
                            'Quien Autoriza': r.quien_autoriza || '',
                            'Quien Entrega': r.quien_entrega || '',
                            'Concepto': r.concepto || '',
                            'Estado': (r.estado || 'pendiente').toUpperCase(),
                            'Fecha Registro': r.created_at ? new Date(r.created_at).toLocaleDateString('es-MX') : 
                                            r.fecha_registro ? new Date(r.fecha_registro).toLocaleDateString('es-MX') : '',
                            'Usuario Registro': r.usuario_registro || '',
                            'Sucursal': r.sucursal_usuario || '',
                            'Numero Lote': r.numero_lote || '',
                            'Numero Solicitud': r.numero_solicitud || '',
                            'Archivos': r.archivos ? r.archivos.length + ' archivo(s)' : '0 archivos',
                            'Evidencia Entrega': r.evidencia_entrega ? 'Sí' : 'No'
                        }));
                        
                        // Crear archivo Excel
                        const ws = XLSX.utils.json_to_sheet(datosExcel);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Reembolsos");
                        
                        XLSX.writeFile(wb, `Reporte_Reembolsos_${new Date().toISOString().split('T')[0]}.xlsx`);
                        mostrarNotificacion('Reporte exportado correctamente', 'success');
                    }

                    function obtenerReembolsosFiltrados() {
                        const fechaDesde = document.getElementById('fechaDesde').value;
                        const fechaHasta = document.getElementById('fechaHasta').value;
                        const estadoFiltro = document.getElementById('filtroEstado').value;
                        const beneficiarioFiltro = document.getElementById('filtroBeneficiario').value.toLowerCase();
                        const loteFiltroEl = document.getElementById('filtroLote');
                        const loteFiltro = loteFiltroEl ? loteFiltroEl.value.toLowerCase().trim() : '';

                        let reembolsosFiltrados = [...reembolsosFiltradosGlobal];

                        if (fechaDesde) {
                            reembolsosFiltrados = reembolsosFiltrados.filter(r => r.fecha >= fechaDesde);
                        }

                        if (fechaHasta) {
                            reembolsosFiltrados = reembolsosFiltrados.filter(r => r.fecha <= fechaHasta);
                        }

                        if (estadoFiltro) {
                            reembolsosFiltrados = reembolsosFiltrados.filter(r => r.estado === estadoFiltro);
                        }

                        if (beneficiarioFiltro) {
                            reembolsosFiltrados = reembolsosFiltrados.filter(r =>
                                r.nombre_beneficiario.toLowerCase().includes(beneficiarioFiltro)
                            );
                        }

                        if (loteFiltro) {
                            reembolsosFiltrados = reembolsosFiltrados.filter(r =>
                                r.numero_lote && r.numero_lote.toLowerCase().includes(loteFiltro)
                            );
                        }

                        return reembolsosFiltrados;
                    }

                    // GESTIÓN DE TABS
                    function showTab(tabName) {
                        // Ocultar todos los tabs
                        const tabs = document.querySelectorAll('.tab-content');
                        tabs.forEach(tab => tab.classList.remove('active'));
                        
                        // Mostrar el tab seleccionado
                        document.getElementById(tabName).classList.add('active');
                        
                        // Actualizar botones de navegación
                        const navTabs = document.querySelectorAll('.nav-tab');
                        navTabs.forEach(tab => tab.classList.remove('active'));
                        event.target.classList.add('active');
                        
                        // Cargar contenido específico del tab
                        if (tabName === 'dashboard') {
                            actualizarDashboard();
                        } else if (tabName === 'revision') {
                            cargarReembolsosRevision();
                        } else if (tabName === 'entregas') {
                            cargarGestionEntregas();
                        } else if (tabName === 'reportes') {
                            generarReporte();
                        }
                    }

                    function cargarReembolsosEnTabs() {
                        // Llamar a las funciones específicas de cada tab
                        cargarReembolsosRevision();
                        cargarGestionEntregas();
                        
                        // Para reportes, llenar automáticamente
                        const tablaReportes = document.getElementById('tablaReportes');
                        if (tablaReportes && reembolsos && reembolsos.length > 0) {
                            tablaReportes.innerHTML = `
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f5f5f5;">
                                            <th style="padding: 10px; border: 1px solid #ddd;">Beneficiario</th>
                                            <th style="padding: 10px; border: 1px solid #ddd;">Concepto</th>
                                            <th style="padding: 10px; border: 1px solid #ddd;">Monto</th>
                                            <th style="padding: 10px; border: 1px solid #ddd;">Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${reembolsos.map(r => `
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${r.nombre_beneficiario}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${r.concepto}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">$${parseFloat(r.monto).toLocaleString()}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${r.estado}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                        }
                    }
                    // UTILIDADES
                    function mostrarLoading(elementId, mostrar) {
                        const elemento = document.getElementById(elementId);
                        if (!elemento) return;
                        
                        if (mostrar) {
                            const originalText = elemento.innerHTML;
                            elemento.setAttribute('data-original', originalText);
                            elemento.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                            elemento.disabled = true;
                        } else {
                            const originalText = elemento.getAttribute('data-original');
                            if (originalText) {
                                elemento.innerHTML = originalText;
                                elemento.removeAttribute('data-original');
                            }
                            elemento.disabled = false;
                        }
                    }

                    function mostrarNotificacion(mensaje, tipo) {
                        const notification = document.getElementById('notification');
                        const text = document.getElementById('notificationText');
                        
                        text.textContent = mensaje;
                        notification.className = `notification ${tipo}`;
                        notification.classList.add('show');
                        
                        setTimeout(() => {
                            notification.classList.remove('show');
                        }, 4000);
                    }

                    // DRAG AND DROP
                    function setupDragAndDrop() {
                        const fileUpload = document.querySelector('.file-upload');
                        
                        if (fileUpload) {
                            fileUpload.addEventListener('dragover', handleDragOver);
                            fileUpload.addEventListener('drop', handleDrop);
                            fileUpload.addEventListener('dragleave', handleDragLeave);
                        }
                    }

                    function handleDragOver(e) {
                        e.preventDefault();
                        e.currentTarget.classList.add('dragover');
                    }

                    function handleDrop(e) {
                        e.preventDefault();
                        e.currentTarget.classList.remove('dragover');
                        
                        const files = e.dataTransfer.files;
                        document.getElementById('archivosReembolso').files = files;
                        mostrarArchivosSeleccionados();
                    }

                    function handleDragLeave(e) {
                        e.currentTarget.classList.remove('dragover');
                    }

                    // EVENTOS DEL DOM
                    document.addEventListener('DOMContentLoaded', function() {
                        console.log('Sistema de Reembolsos No Deducibles inicializando...');
                        
                        // Event listeners
                        const loginForm = document.getElementById('loginForm');
                        const archivosReembolso = document.getElementById('archivosReembolso');
                        const excelMasivo = document.getElementById('excelMasivo');
                        const nombreBeneficiario = document.getElementById('nombreBeneficiario');
                        
                        if (loginForm) {
                            loginForm.addEventListener('submit', login);
                        }
                        
                        if (archivosReembolso) {
                            archivosReembolso.addEventListener('change', mostrarArchivosSeleccionados);
                        }
                        
                        if (excelMasivo) {
                            excelMasivo.addEventListener('change', procesarExcelMasivo);
                        }
                        
                        // Setup de autocompletado
                        setupAutocompletado();
                        
                        // Setup drag and drop
                        setupDragAndDrop();
                        
                        // Verificar sesión activa
                        verificarSesion();
                        
                        console.log('Sistema inicializado correctamente');
                    });

                    // Cerrar modales con Escape
                    document.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') {
                            cerrarModal();
                        }
                    });

                    // Cerrar modales al hacer clic fuera
                    document.addEventListener('click', function(e) {
                        if (e.target.classList.contains('modal')) {
                            cerrarModal();
                        }
                    });


                    // EN EL HTML - Modificar la función enviarSolicitudAutorizacion():

                    async function enviarSolicitudAutorizacion() {
                        // Obtener el botón y deshabilitarlo inmediatamente
                        const btnEnviar = document.getElementById('btnEnviarAutorizacion');
                        if (btnEnviar.disabled) return; // Prevenir doble clic

                        btnEnviar.disabled = true;
                        const textoOriginal = btnEnviar.innerHTML;
                        btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

                        try {
                            let reembolsosFiltrados = filtrarReembolsosPorUsuario(reembolsos);
                            const reembolsosPendientes = reembolsosFiltrados.filter(r => r.estado === 'pendiente');

                            if (reembolsosPendientes.length === 0) {
                                mostrarNotificacion('No hay comprobantes pendientes para enviar', 'error');
                                btnEnviar.disabled = false;
                                btnEnviar.innerHTML = textoOriginal;
                                return;
                            }
                        
                            let numeroLote = prompt('Ingresa el número de lote para este corte (solo números):');

                            if (!numeroLote || numeroLote.trim() === '') {
                                mostrarNotificacion('Debes ingresar un número de lote', 'warning');
                                btnEnviar.disabled = false;
                                btnEnviar.innerHTML = textoOriginal;
                                return;
                            }

                            // Validar que solo contenga números
                            if (!/^\d+$/.test(numeroLote.trim())) {
                                mostrarNotificacion('El número de lote debe contener ÚNICAMENTE números. Ejemplo: 41', 'error');
                                btnEnviar.disabled = false;
                                btnEnviar.innerHTML = textoOriginal;
                                return;
                            }

                            const nombreUsuario = currentUser.nombre.split(' ')[0].toUpperCase();
                            const numeroLoteCompleto = `${numeroLote.trim()}-${nombreUsuario}`;

                            const totalImagenes = reembolsosPendientes.reduce((total, reembolso) => {
                                return total + (reembolso.archivos ? reembolso.archivos.length : 0);
                            }, 0);

                            const confirmacion = confirm(
                                `¿Enviar solicitud de autorización?\n\n` +
                                `• Número de lote: ${numeroLoteCompleto}\n` +
                                `• Solicitudes: ${reembolsosPendientes.length}\n` +
                                `• Total: $${reembolsosPendientes.reduce((sum, r) => sum + parseFloat(r.monto), 0).toLocaleString()}\n` +
                                `• Comprobantes: ${totalImagenes} imágenes (se enviarán en 1 PDF)\n` +
                                `• Se enviará a: balderramafernando@gmail.com`
                            );

                            if (!confirmacion) {
                                btnEnviar.disabled = false;
                                btnEnviar.innerHTML = textoOriginal;
                                return;
                            }

                            mostrarNotificacion('Generando PDF y enviando correo...', 'info');
                            
                            const datosCorreo = {
                                reembolsos: reembolsosPendientes,
                                emailRemitente: currentUser.email,
                                nombreRemitente: currentUser.nombre,
                                fechaEnvio: new Date().toISOString(),
                                totalMonto: reembolsosPendientes.reduce((sum, r) => sum + parseFloat(r.monto), 0),
                                sucursalUsuario: currentUser.sucursal,
                                numeroLoteUsuario: numeroLoteCompleto
                            };
                            
                            console.log('Enviando correo con datos:', datosCorreo);
                            
                            const response = await enviarCorreoAutorizacion(datosCorreo);
                            
                            console.log('Respuesta del servidor:', response);
                            
                            if (response.success) {
                                try {
                                    console.log('Actualizando estados a en_corte...');
                                    
                                    // Y cámbialo por:
                                    const updatePromises = reembolsosPendientes.map(reembolso =>
                                        supabase
                                            .from('rnd_reembolsos')
                                            .update({ 
                                                estado: 'en_corte',
                                                numero_lote: numeroLoteCompleto  // Agregar esta línea
                                            })
                                            .eq('id', reembolso.id)
                                    );
                                    
                                    await Promise.all(updatePromises);
                                    
                                    console.log('Estados actualizados exitosamente');
                                    
                                    reembolsosPendientes.forEach(r => {
                                        r.estado = 'en_corte';
                                        r.numero_solicitud = numeroLoteCompleto;
                                    });
                                    
                                    cargarReembolsosRevision();
                                    actualizarDashboard();
                                    
                                    const mensaje = `Correo enviado exitosamente\n\n` +
                                                `• Número de lote: ${numeroLoteCompleto}\n` +
                                                `• Reembolsos procesados: ${reembolsosPendientes.length}\n` +
                                                `• Estados actualizados a: EN_CORTE`;
                                                
                                    mostrarNotificacion(mensaje, 'success');
                                    
                                } catch (updateError) {
                                    console.error('Error actualizando estados:', updateError);
                                    mostrarNotificacion('Correo enviado, pero error actualizando estados: ' + updateError.message, 'warning');
                                }
                                
                            } else {
                                mostrarNotificacion('Error enviando correo: ' + response.error, 'error');
                            }
                            
                        } catch (error) {
                            mostrarNotificacion('Error enviando solicitud', 'error');
                            console.error('Error completo:', error);
                        } finally {
                            // Rehabilitar el botón siempre, sin importar el resultado
                            btnEnviar.disabled = false;
                            btnEnviar.innerHTML = textoOriginal;
                        }
                    }


                    // ===============================
                    // ENVIAR CORREO CON RESEND (Nueva función)
                    // ===============================
                    // REEMPLAZAR función enviarCorreoSolicitudEntrega
                    async function enviarCorreoSolicitudEntrega(datos) {
                        try {
                            const { data, error } = await supabase.functions.invoke('send-email', {
                                body: {
                                    tipo: 'solicitud_entrega',
                                    datos: datos
                                }
                            });
                            
                            if (error) throw error;
                            
                            console.log('Correo enviado exitosamente');
                            return { success: true, data };
                            
                        } catch (error) {
                            console.error('Error enviando correo:', error);
                            throw error;
                        }
                    }

                    // AGREGAR función para correo de autorización
                    // FUNCIÓN para correo de autorización (Fernando)
                    // ✅ FUNCIÓN CORREGIDA PARA ENVIAR CORREO DE AUTORIZACIÓN
                    async function enviarCorreoAutorizacion(datosReembolsos) {
                        try {
                            // Cambiar el formato del número - usar el número de lote del usuario
                            const numeroReembolso = datosReembolsos.numeroLoteUsuario; // En lugar de `RND-${Date.now()}`
                            
                            const emailHTML = `
                                <!DOCTYPE html>
                                <html>
                                <head>
                                    <meta charset="UTF-8">
                                    <style>
                                        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
                                        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                                        .logo { font-size: 28px; font-weight: bold; color: #1a365d; }
                                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                                        th { background-color: #f2f2f2; font-weight: bold; }
                                        .total-row { background-color: #e8f4f8; font-weight: bold; }
                                        .auth-box { background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107; }
                                        .adjuntos-box { background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #0066cc; }
                                    </style>
                                </head>
                                <body>
                                    <div class="container">
                                        <div class="header">
                                            <div class="logo">ACEROS CABOS</div>
                                            <p>Sistema de Reembolsos No Deducibles</p>
                                        </div>
                                        
                                        <h2>📋 Autorización ${numeroReembolso}</h2>
                                        
                                        <p><strong>Fecha:</strong> ${new Date().toLocaleDateString('es-MX')}</p>
                                        <p><strong>Solicitante:</strong> ${datosReembolsos.nombreRemitente}</p>
                                        <p><strong>Sucursal:</strong> ${datosReembolsos.sucursalUsuario}</p>
                                        
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Beneficiario</th>
                                                    <th>Concepto</th>
                                                    <th>Fecha</th>
                                                    <th>Monto</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${datosReembolsos.reembolsos.map(r => `
                                                    <tr>
                                                        <td>${r.nombre_beneficiario}</td>
                                                        <td>${r.concepto}</td>
                                                        <td>${new Date(r.fecha + 'T12:00:00').toLocaleDateString('es-MX')}</td>
                                                        <td style="text-align: right;">$${parseFloat(r.monto).toLocaleString()}</td>
                                                    </tr>
                                                `).join('')}
                                                <tr class="total-row">
                                                    <td colspan="3" style="text-align: center;"><strong>TOTAL</strong></td>
                                                    <td style="text-align: right;"><strong>$${datosReembolsos.totalMonto.toLocaleString()}</strong></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        
                                        <div class="adjuntos-box">
                                            <h4>📎📎📎📎📎📎 Comprobantes Adjuntos</h4>
                                            <p>Se incluyen ${datosReembolsos.reembolsos.reduce((total, r) => total + (r.archivos ? r.archivos.length : 0), 0)} imagen(es) como archivos adjuntos en este correo.</p>
                                        </div>
                                        
                                        <div class="auth-box">
                                            <h4>Para autorizar:</h4>
                                            <p>✅ <strong>RESPONDER:</strong> "AUTORIZO"</p>
                                            <p>❌ <strong>RESPONDER:</strong> "RECHAZO"</p>
                                        </div>
                                        
                                        <p style="color: #666; font-size: 12px; text-align: center; margin-top: 30px;">
                                            Fecha: ${new Date().toLocaleDateString('es-MX')}<br>
                                            Saludos: ${datosReembolsos.nombreRemitente}
                                        </p>
                                    </div>
                                </body>
                                </html>
                            `;

                            console.log('Llamando a enviarEmailConResend...');
                            
                            const resultado = await enviarEmailConResend({
                                destinatarios: ['jafita1810@gmail.com'],
                                subject: `AUTORIZACIÓN ${numeroReembolso}`, // Cambiar el subject también
                                html: emailHTML,
                                reembolsos: datosReembolsos.reembolsos // Para adjuntar archivos
                            });

                            console.log('Resultado del envío:', resultado);
                            
                            if (resultado.success) {
                                return { 
                                    success: true, 
                                    numeroCorte: numeroReembolso,
                                    data: resultado.data 
                                };
                            } else {
                                throw new Error(resultado.error || 'Error enviando correo');
                            }

                        } catch (error) {
                            console.error('Error en enviarCorreoAutorizacion:', error);
                            return { success: false, error: error.message };
                        }
                    }


            async function recargarDatosCompletos() {
                mostrarNotificacion('Actualizando datos...', 'info');
                await cargarDatos();
                cargarReembolsosRevision();
                actualizarDashboard();
                mostrarNotificacion('Datos actualizados', 'success');
            }

            // Nueva función para generar PDF:
            async function generarPDFSolicitud() {
                const reembolsosAprobados = reembolsos.filter(r => r.estado === 'aprobado');
                
                if (reembolsosAprobados.length === 0) {
                    mostrarNotificacion('No hay comprobantes aprobados', 'error');
                    return;
                }
                
                try {
                    mostrarNotificacion('Generando PDF...', 'info');

                    const sucursalRegistro = reembolsosAprobados[0].sucursal_usuario; // Sucursal del usuario que registró
                    const numeroSolicitud = generarNumeroSolicitud(sucursalRegistro);
                    const datosEntrega = {
                        ids: reembolsosAprobados.map(r => r.id),
                        reembolsos: reembolsosAprobados,
                        numeroSolicitud: numeroSolicitud,
                        fechaSolicitud: new Date().toISOString(),
                        usuarioSolicitud: currentUser.email,
                        nombreSolicitante: currentUser.nombre,
                        sucursal: reembolsosAprobados[0].sucursal_usuario, // Sucursal del usuario que registró el reembolso
                        totalMonto: reembolsosAprobados.reduce((sum, r) => sum + parseFloat(r.monto), 0)
                    };
                    
                    // 1. PRIMERO ACTUALIZAR EN BACKEND
                    console.log('Enviando datos al backend:', datosEntrega);
                    const response = await solicitarEntregaCompleta(datosEntrega);
                    console.log('Respuesta del backend:', response);
                    
                    if (response.success) {
                        // 2. DESPUÉS GENERAR PDF LOCAL
                        const ventana = window.open('', '_blank');
                        ventana.document.write(generarHTMLParaImprimir(datosEntrega));
                        ventana.document.close();
                        
                        setTimeout(() => {
                            ventana.print();
                        }, 500);
                        
                        mostrarNotificacion('PDF generado y estados actualizados en servidor', 'success');
                        
                        // 3. ACTUALIZAR LOCAL SOLO DESPUÉS DE CONFIRMAR BACKEND
                        reembolsosAprobados.forEach(r => {
                            r.estado = 'solicitado_entrega';
                            r.progreso = 90;
                        });
                        
                        // 4. RECARGAR DATOS DESDE BACKEND PARA CONFIRMAR
                        setTimeout(async () => {
                            await cargarDatos(); // Esto recarga desde Google Sheets
                            cargarGestionEntregas();
                            actualizarDashboard();
                        }, 2000);
                        
                    } else {
                        mostrarNotificacion('Error actualizando estados: ' + response.error, 'error');
                        console.error('Error del backend:', response);
                    }
                    
                } catch (error) {
                    mostrarNotificacion('Error generando solicitud', 'error');
                    console.error('Error completo:', error);
                }
            }

        // ENVIAR CORREO VIA APPS SCRIPT
        async function enviarEmailConResend(datos) {
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwYGG6rjqh7Jtx5U9kI58k33rZ_dv9XmRkFeu8sd2T8zyqkVQXcY_NU7kDD_NZ5-MCtYQ/exec';

            console.log('Enviando correo via Apps Script...');
            console.log('Datos:', datos);

            try {
                const payload = {
                    action: 'ENVIAR_CORREO_AUTORIZACION',
                    data: datos
                };

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify(payload),
                    redirect: 'follow'
                });

                console.log('Response status:', response.status);

                const text = await response.text();
                console.log('Response text:', text);

                let result;
                try {
                    result = JSON.parse(text);
                } catch (parseError) {
                    console.error('No se pudo parsear respuesta:', text);
                    throw new Error('Respuesta invalida del servidor: ' + text.substring(0, 200));
                }

                console.log('Resultado:', result);

                if (result.success) {
                    return { success: true, data: result };
                } else {
                    throw new Error(result.error || 'Error desconocido del servidor');
                }

            } catch (error) {
                console.error('Error enviando correo:', error);
                return { success: false, error: error.message };
            }
        }
        

            function generarHTMLParaImprimir(datos) {
                const fechaHoy = new Date().toLocaleDateString('es-MX');
                
                return `
                    <html>
                    <head>
                        <title>Solicitud de Entrega - ${datos.numeroSolicitud}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 40px; 
                                font-size: 14px;
                            }
                            .header { 
                                text-align: center; 
                                margin-bottom: 30px; 
                                border-bottom: 2px solid #333;
                                padding-bottom: 20px;
                            }
                            .logo { 
                                font-size: 28px; 
                                font-weight: bold; 
                                color: #1a365d; 
                            }
                            .info-box { 
                                background: #f7fafc; 
                                padding: 15px; 
                                border-radius: 8px; 
                                margin: 20px 0; 
                                border: 1px solid #e2e8f0;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin: 20px 0; 
                            }
                            th, td { 
                                border: 1px solid #333; 
                                padding: 12px; 
                                text-align: left; 
                            }
                            th { 
                                background-color: #f0f0f0; 
                                font-weight: bold; 
                            }
                            .total-row { 
                                background-color: #e6f3ff; 
                                font-weight: bold; 
                                font-size: 16px;
                            }
                            .signatures { 
                                margin-top: 60px; 
                                display: flex; 
                                justify-content: space-between; 
                            }
                            .signature-box { 
                                text-align: center; 
                                width: 250px; 
                            }
                            .signature-line { 
                                border-bottom: 2px solid #333; 
                                margin-bottom: 10px; 
                                height: 80px; 
                            }
                            .footer {
                                margin-top: 40px;
                                font-size: 12px;
                                color: #666;
                                text-align: center;
                            }
                            @media print {
                                body { margin: 20px; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="logo">ACEROS CABOS, S.A. DE C.V.</div>
                            <h2>SOLICITUD DE ENTREGA DE REEMBOLSOS</h2>
                            <h3>No. ${datos.numeroSolicitud}</h3>
                        </div>
                        
                        <div class="info-box">
                            <p><strong>Fecha:</strong> ${fechaHoy}</p>
                            <p><strong>Solicitado por:</strong> ${datos.nombreSolicitante}</p>
                            <p><strong>Sucursal:</strong> ${datos.sucursal}</p>
                            <p><strong>Total de comprobantes:</strong> ${datos.reembolsos.length}</p>
                            <p><strong>Monto total:</strong> $${datos.totalMonto.toLocaleString()}</p>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 15%;">LOTE</th>
                                    <th style="width: 20%;">BENEFICIARIO</th>
                                    <th style="width: 30%;">CONCEPTO</th>
                                    <th style="width: 15%;">FECHA</th>
                                    <th style="width: 20%;">MONTO</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${datos.reembolsos.map(r => `
                                    <tr>
                                        <td>${r.numero_lote || 'N/A'}</td>
                                        <td>${r.nombre_beneficiario}</td>
                                        <td>${r.concepto}</td>
                                        <td>${new Date(r.fecha + 'T12:00:00').toLocaleDateString('es-MX')}</td>
                                        <td style="text-align: right;">$${parseFloat(r.monto).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                                <tr class="total-row">
                                    <td colspan="3" style="text-align: center;"><strong>TOTAL A ENTREGAR</strong></td>
                                    <td style="text-align: right;"><strong>$${datos.totalMonto.toLocaleString()}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="info-box">
                            <h4>OBSERVACIONES:</h4>
                            <p>• Los reembolsos listados han sido previamente autorizados por Fernando Balderrama.</p>
                            <p>• Se solicita la entrega del efectivo correspondiente para su distribución.</p>
                            <p>• Este documento debe ser firmado por ambas partes como comprobante de entrega.</p>
                        </div>
                        
                        <div class="signatures">
                            <div class="signature-box">
                                <div class="signature-line"></div>
                                <p><strong>SOLICITA Y RECIBE</strong></p>
                                <p>${datos.nombreSolicitante}</p>
                                <p>Fecha: _________________</p>
                            </div>
                            <div class="signature-box">
                                <div class="signature-line"></div>
                                <p><strong>ENTREGA</strong></p>
                                <p>Irma</p>
                                <p>Fecha: _________________</p>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p>Sistema de Reembolsos No Deducibles - ACEROS CABOS</p>
                            <p>Documento generado el ${new Date().toLocaleString('es-MX')}</p>
                        </div>
                    </body>
                    </html>
                `;
            }


            // ===============================
            // SOLICITAR ENTREGA (Reemplazar solicitarEntregaCompleta)
            // ===============================
            // FUNCIÓN para solicitud de entrega (IGUAL que Apps Script)
            async function solicitarEntregaCompleta(datos) {
                try {
                    console.log('=== SOLICITANDO ENTREGA EN SUPABASE ===');
                    
                    // 1. Actualizar estados en Supabase
                    const updatePromises = datos.ids.map(id => 
                        supabase
                            .from('rnd_reembolsos')
                            .update({
                                estado: 'solicitado_entrega',
                                numero_solicitud: datos.numeroSolicitud
                            })
                            .eq('id', id)
                    );
                    
                    await Promise.all(updatePromises);

                    // 2. Generar HTML para PDF local (mantener)
                    const fechaHoy = new Date().toLocaleDateString('es-MX', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    return { success: true };
                    
                } catch (error) {
                    console.error('Error:', error);
                    return { success: false, error: error.message };
                }
            }
            async function testDebugDatos() {
                const reembolsosPendientes = reembolsos.filter(r => r.estado === 'pendiente');
                
                if (reembolsosPendientes.length === 0) {
                    console.log('No hay reembolsos pendientes');
                    return;
                }
                
                const datosTest = {
                    reembolsos: reembolsosPendientes.slice(0, 1),
                    emailRemitente: currentUser.email,
                    nombreRemitente: currentUser.nombre,
                    totalMonto: reembolsosPendientes[0].monto
                };
                
                console.log('Datos a enviar para debug:', datosTest);
                
                // CORREGIR AQUÍ - no enviar action dentro de data
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = GOOGLE_SCRIPT_URL;
                form.target = 'hidden-iframe-debug';
                form.style.display = 'none';
                
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden-iframe-debug';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
                
                const payload = {
                    action: 'DEBUG_DATOS',  // ← AQUÍ, no dentro de data
                    data: datosTest         // ← AQUÍ solo los datos
                };
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'postData';
                input.value = JSON.stringify(payload);
                form.appendChild(input);
                
                document.body.appendChild(form);
                form.submit();
                
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }, 3000);
            }


            async function subirEvidenciaEntrega() {
                const reembolsosSolicitados = reembolsos.filter(r => r.estado === 'solicitado_entrega');
                
                console.log('🔍 DEBUG - Reembolsos solicitados:', reembolsosSolicitados);
                console.log('🔍 DEBUG - Estructura primer reembolso:', reembolsosSolicitados[0]);
                console.log('🔍 DEBUG - ID del primer reembolso:', reembolsosSolicitados[0] ? reembolsosSolicitados[0].id : 'N/A');
                
                if (reembolsosSolicitados.length === 0) {
                    mostrarNotificacion('No hay solicitudes pendientes de entrega', 'error');
                    return;
                }
                
                return new Promise((resolve) => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*,application/pdf';
                    input.style.display = 'none';
                    
                    input.onchange = async function(e) {
                        const archivo = e.target.files[0];
                        
                        // VERIFICACIÓN ESTRICTA - si no hay archivo, salir inmediatamente
                        if (!archivo) {
                            console.log('No se seleccionó archivo - cancelando operación');
                            document.body.removeChild(input);
                            resolve(false);
                            return;
                        }
                        
                        // Validar tamaño
                        if (archivo.size > 10 * 1024 * 1024) {
                            mostrarNotificacion('El archivo es demasiado grande (máximo 10MB)', 'error');
                            document.body.removeChild(input);
                            resolve(false);
                            return;
                        }
                        
                        try {
                            mostrarNotificacion('Procesando evidencia...', 'info');
                            console.log('Procesando archivo:', archivo.name);
                            
                            const base64 = await convertirArchivoABase64(archivo);
                            
                            const datosEvidencia = {
                                reembolsos: reembolsosSolicitados,
                                evidencia: {
                                    nombre: archivo.name,
                                    tipo: archivo.type,
                                    tamaño: archivo.size,
                                    base64: base64
                                },
                                fechaEntrega: new Date().toISOString(),
                                usuarioEntrega: currentUser.email,
                                totalMonto: reembolsosSolicitados.reduce((sum, r) => sum + parseFloat(r.monto), 0)
                            };
                            
                            console.log('Enviando evidencia al backend...');
                            const response = await confirmarEntregaConEvidencia(datosEvidencia);
                            
                            if (response.success) {
                                mostrarNotificacion('Entrega confirmada exitosamente', 'success');
                                
                                // Actualizar estados localmente SOLO si fue exitoso
                                reembolsosSolicitados.forEach(r => {
                                    r.estado = 'entregado';
                                    r.progreso = 100;
                                    r.fechaEntrega = new Date().toISOString();
                                });
                                
                                setTimeout(async () => {
                                    await cargarDatos();
                                    cargarGestionEntregas();
                                    actualizarDashboard();
                                }, 1000);
                                
                                resolve(true);
                            } else {
                                mostrarNotificacion('Error confirmando entrega: ' + response.error, 'error');
                                resolve(false);
                            }
                            
                        } catch (error) {
                            console.error('Error procesando archivo:', error);
                            mostrarNotificacion('Error procesando archivo: ' + error.message, 'error');
                            resolve(false);
                        }
                        
                        // Limpiar input
                        document.body.removeChild(input);
                    };
                    
                    // Evento para detectar cancelación (cuando se cierra el diálogo sin seleccionar)
                    input.oncancel = function() {
                        console.log('Diálogo de archivo cancelado');
                        document.body.removeChild(input);
                        resolve(false);
                    };
                    
                    // Detectar cuando se enfoca la ventana de nuevo (posible cancelación)
                    const handleFocus = () => {
                        setTimeout(() => {
                            if (input.files.length === 0) {
                                console.log('No se seleccionó archivo - usuario canceló');
                                if (document.body.contains(input)) {
                                    document.body.removeChild(input);
                                }
                                window.removeEventListener('focus', handleFocus);
                                resolve(false);
                            }
                        }, 100);
                    };
                    
                    window.addEventListener('focus', handleFocus);
                    
                    // Activar el input
                    document.body.appendChild(input);
                    input.click();
                });
            }

            async function confirmarEntregaConEvidencia(datos) {
                try {
                    console.log('=== CONFIRMANDO ENTREGA CON EVIDENCIA ===');
                    
                    // 1. Subir evidencia a Supabase Storage
                    const fileName = `evidencia_entrega_${Date.now()}_${datos.evidencia.nombre}`;
                    
                    const response = await fetch(`data:${datos.evidencia.tipo};base64,${datos.evidencia.base64}`);
                    const blob = await response.blob();
                    
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('rnd-documentos')
                        .upload(`evidencias/${fileName}`, blob, {
                            contentType: datos.evidencia.tipo
                        });
                    
                    if (uploadError) {
                        console.error('Error subiendo archivo:', uploadError);
                        throw uploadError;
                    }
                    
                    const { data: urlData } = supabase.storage
                        .from('rnd-documentos')
                        .getPublicUrl(`evidencias/${fileName}`);
                    
                    const evidenciaUrl = urlData.publicUrl;
                    console.log('✅ Evidencia subida:', evidenciaUrl);
                    
                    // 2. VERSIÓN SIMPLIFICADA - Solo actualizar campos que existen
                    let actualizados = 0;
                    
                    for (const reembolso of datos.reembolsos) {
                        try {
                            console.log(`📝 Actualizando reembolso ID: ${reembolso.id} - ${reembolso.nombre_beneficiario}`);
                            
                            const { data: updateData, error: updateError } = await supabase
                                .from('rnd_reembolsos')
                                .update({
                                    estado: 'entregado',
                                    // Solo actualizar campos que sabemos que existen
                                    evidencia_entrega: {
                                        url: evidenciaUrl,
                                        nombre: datos.evidencia.nombre,
                                        fecha_subida: datos.fechaEntrega
                                    },
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', reembolso.id);
                            
                            if (updateError) {
                                console.error(`❌ Error actualizando ${reembolso.nombre_beneficiario}:`, updateError);
                            } else {
                                console.log(`✅ Actualizado: ${reembolso.nombre_beneficiario}`);
                                actualizados++;
                            }
                            
                        } catch (error) {
                            console.error(`❌ Error procesando ${reembolso.nombre_beneficiario}:`, error);
                        }
                    }
                    
                    console.log(`📊 Resultado: ${actualizados}/${datos.reembolsos.length} comprobantes actualizados`);
                    
                    return { 
                        success: actualizados > 0, 
                        evidenciaUrl: evidenciaUrl,
                        reembolsosActualizados: actualizados 
                    };
                    
                } catch (error) {
                    console.error('❌ Error confirmando entrega:', error);
                    return { 
                        success: false, 
                        error: error.message 
                    };
                }
            }
            function editarReembolso(id) {
                const reembolso = reembolsos.find(r => r.id === id);
                if (!reembolso) return;
                
                // Abrir modal con formulario de edición
                const modal = document.getElementById('modalReembolso');
                const contenido = document.getElementById('contenidoModal');
                
                contenido.innerHTML = `
                    <h2><i class="fas fa-edit"></i> Editar Reembolso</h2>
                    
                    <div class="form-group">
                        <label>Archivos Actuales:</label>
                        ${(reembolso.archivos || []).map((a, i) => `
                            <div style="margin: 5px 0;">
                                ${typeof a === 'string' ? a.split('/').pop() : a.nombre || 'Archivo ' + (i+1)}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="form-group">
                        <label>Agregar Más Archivos:</label>
                        <input type="file" id="editarArchivos" multiple accept="image/*,application/pdf">
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="cerrarModal()" style="margin-right: 10px;">
                            Cancelar
                        </button>
                        <button class="btn btn-success" onclick="guardarEdicion(${id})">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                `;
                
                modal.classList.add('active');
            }

            async function guardarEdicion(id) {
                console.log('=== GUARDAR EDICIÓN ===');
                console.log('ID del reembolso:', id);
                
                const archivosInput = document.getElementById('editarArchivos');
                console.log('Input encontrado:', archivosInput ? 'SÍ' : 'NO');
                
                const archivos = Array.from(archivosInput.files);
                console.log('Archivos seleccionados:', archivos.length);
                
                if (archivos.length === 0) {
                    mostrarNotificacion('No seleccionaste archivos nuevos', 'warning');
                    cerrarModal();
                    return;
                }
                
                try {
                    mostrarNotificacion('Subiendo archivos...', 'info');
                    
                    const reembolso = reembolsos.find(r => r.id === id);
                    console.log('Reembolso encontrado:', reembolso ? 'SÍ' : 'NO');
                    
                    if (!reembolso) {
                        mostrarNotificacion('Error: Reembolso no encontrado', 'error');
                        return;
                    }
                    
                    // Convertir archivos a base64
                    let archivosNuevos = [];
                    for (const archivo of archivos) {
                        console.log('Procesando archivo:', archivo.name);
                        const base64 = await convertirArchivoABase64(archivo);
                        archivosNuevos.push({
                            nombre: archivo.name,
                            tipo: archivo.type,
                            tamaño: archivo.size,
                            base64: base64
                        });
                    }
                    
                    console.log('Archivos convertidos:', archivosNuevos.length);
                    
                    const datosActualizacion = {
                        reembolsoOriginalId: id,
                        archivos: archivosNuevos,
                        usuario_registro: currentUser.email,
                        nombre_beneficiario: reembolso.nombre_beneficiario
                    };
                    
                    console.log('Enviando datos:', datosActualizacion);
                    
                    const response = await enviarReembolso(datosActualizacion);
                    console.log('Respuesta recibida:', response);
                    
                    cerrarModal();
                    mostrarNotificacion('Subiendo archivos... espera 5 segundos', 'info');
                    
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    
                    await cargarDatos();
                    
                    mostrarNotificacion('✅ Archivos agregados correctamente', 'success');
                    
                    if (document.getElementById('reportes').classList.contains('active')) {
                        generarReporte();
                    }
                    
                } catch (error) {
                    console.error('❌ ERROR:', error);
                    mostrarNotificacion('Error: ' + error.message, 'error');
                }
            }

            console.log('Sistema de Reembolsos No Deducibles ACEROS CABOS cargado');

        async function verificarEmpleados() {
            const { data, error } = await supabase
                .from('rnd_empleados')
                .select('*');
            
            console.log('👷 Empleados en BD:', data);
            console.log('❌ Error:', error);
            
            if (!data || data.length === 0) {
                console.log('⚠️ No hay empleados. Insertando algunos...')
                
                const { data: insertData, error: insertError } = await supabase
                    .from('rnd_empleados')
                    .insert(empleadosTest)
                    .select();
                
                console.log('✅ Empleados insertados:', insertData);
                console.log('❌ Error insertando:', insertError);
            }
        }

        verificarEmpleados();

        // Llamar desde tu frontend
        async function comprimirArchivosExistentes() {
            try {
                mostrarNotificacion('Comprimiendo archivos existentes...', 'info')
                
                const response = await fetch('https://uqncsqstpcynjxnjhrqu.supabase.co/functions/v1/supabase-functions-deploy-compress-existing-files', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                })
                
                const result = await response.json()
                
                if (result.success) {
                    mostrarNotificacion(`Compresión completada: ${result.comprimidos} archivos`, 'success')
                } else {
                    mostrarNotificacion('Error: ' + result.error, 'error')
                }
            } catch (error) {
                mostrarNotificacion('Error comprimiendo archivos', 'error')
            }
        }

        // CARGAR AUTORIZADORES Y CONCEPTOS ÚNICOS
        async function cargarAutorizadoresYConceptos() {
            try {
                // Cargar autorizadores únicos
                const { data: dataAutorizadores, error: errorAuth } = await supabase
                    .from('rnd_reembolsos')
                    .select('quien_autoriza')
                    .not('quien_autoriza', 'is', null)
                    .not('quien_autoriza', 'eq', '');
                
                if (!errorAuth && dataAutorizadores) {
                    const autorizadoresUnicos = [...new Set(dataAutorizadores.map(r => r.quien_autoriza))];
                    autorizadores = autorizadoresUnicos.sort();
                }

                // Cargar conceptos únicos
                const { data: dataConceptos, error: errorConc } = await supabase
                    .from('rnd_reembolsos')
                    .select('concepto')
                    .not('concepto', 'is', null)
                    .not('concepto', 'eq', '');
                
                if (!errorConc && dataConceptos) {
                    const conceptosUnicos = [...new Set(dataConceptos.map(r => r.concepto))];
                    conceptosFrecuentes = conceptosUnicos.sort();
                }

                console.log('✅ Autorizadores cargados:', autorizadores.length);
                console.log('✅ Conceptos cargados:', conceptosFrecuentes.length);
                
            } catch (error) {
                console.error('Error cargando autorizadores y conceptos:', error);
            }
        }

        // AUTOCOMPLETADO PARA QUIEN AUTORIZA
        // YA NO SE USA - Ahora "Quien Autoriza" es un select con lista fija
        /*
        function setupAutocompletadoAutoriza() {
            const input = document.getElementById('quienAutoriza');
            const suggestionsList = document.getElementById('autorizaSuggestionsList');

            if (!input || !suggestionsList) return;

            input.addEventListener('input', function() {
                const valor = this.value.toLowerCase().trim();
                suggestionsList.innerHTML = '';

                if (valor.length < 2) {
                    suggestionsList.style.display = 'none';
                    return;
                }

                const coincidencias = autorizadores.filter(auth =>
                    auth.toLowerCase().includes(valor)
                );

                // Mostrar coincidencias existentes
                if (coincidencias.length > 0) {
                    coincidencias.slice(0, 5).forEach(auth => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.textContent = auth;
                        item.onclick = () => {
                            input.value = auth;
                            suggestionsList.style.display = 'none';
                        };
                        suggestionsList.appendChild(item);
                    });
                }

                // Opción para crear nuevo
                if (!coincidencias.includes(this.value) && this.value.length > 0) {
                    const addNew = document.createElement('div');
                    addNew.className = 'suggestion-item add-new-option';
                    addNew.innerHTML = `<i class="fas fa-plus"></i> Crear: "${this.value}"`;
                    addNew.onclick = () => {
                        input.value = this.value;
                        autorizadores.push(this.value);
                        suggestionsList.style.display = 'none';
                    };
                    suggestionsList.appendChild(addNew);
                }

                suggestionsList.style.display = 'block';
            });

            // Cerrar al hacer click fuera
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestionsList.contains(e.target)) {
                    suggestionsList.style.display = 'none';
                }
            });
        }
        */

        // AUTOCOMPLETADO PARA CONCEPTOS
        function setupAutocompletadoConcepto() {
            const input = document.getElementById('conceptoReembolso');
            const suggestionsList = document.getElementById('conceptoSuggestionsList');
            
            if (!input || !suggestionsList) return;
            
            input.addEventListener('input', function() {
                const valor = this.value.toLowerCase().trim();
                suggestionsList.innerHTML = '';
                
                if (valor.length < 3) {
                    suggestionsList.style.display = 'none';
                    return;
                }
                
                const coincidencias = conceptosFrecuentes.filter(concepto => 
                    concepto.toLowerCase().includes(valor)
                );
                
                // Mostrar coincidencias existentes
                if (coincidencias.length > 0) {
                    coincidencias.slice(0, 5).forEach(concepto => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.textContent = concepto;
                        item.onclick = () => {
                            input.value = concepto;
                            suggestionsList.style.display = 'none';
                        };
                        suggestionsList.appendChild(item);
                    });
                }
                
                // Opción para crear nuevo
                if (!coincidencias.includes(this.value) && this.value.length > 0) {
                    const addNew = document.createElement('div');
                    addNew.className = 'suggestion-item add-new-option';
                    addNew.innerHTML = `<i class="fas fa-plus"></i> Usar: "${this.value}"`;
                    addNew.onclick = () => {
                        input.value = this.value;
                        conceptosFrecuentes.push(this.value);
                        suggestionsList.style.display = 'none';
                    };
                    suggestionsList.appendChild(addNew);
                }
                
                suggestionsList.style.display = 'block';
            });
            
            // Cerrar al hacer click fuera
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestionsList.contains(e.target)) {
                    suggestionsList.style.display = 'none';
                }
            });
        }


        // ===============================
        // VALIDACIÓN DE COMIDA POR BENEFICIARIO POR DÍA
        // ===============================
        async function validarComidaPorBeneficiarioPorDia(beneficiario, fecha, concepto) {
            try {
                // Palabras clave que identifican conceptos de comida
                const palabrasComida = [
                    'comida', 'almuerzo', 'desayuno', 'cena', 'alimento', 'alimentación', 
                    'restaurant', 'restaurante', 'café', 'cafetería', 'food', 'lunch', 
                    'dinner', 'breakfast', 'snack', 'merienda', 'refrigerio'
                ];
                
                // Verificar si el concepto contiene palabras relacionadas con comida
                const esConceptoComida = palabrasComida.some(palabra => 
                    concepto.toLowerCase().includes(palabra.toLowerCase())
                );
                
                if (!esConceptoComida) {
                    return { valido: true }; // No es concepto de comida, permitir
                }
                
                console.log(`🍽️ Validando comida para ${beneficiario} en fecha ${fecha}`);
                
                // Buscar si ya existe un reembolso de comida para este beneficiario en esta fecha
                const { data, error } = await supabase
                    .from('rnd_reembolsos')
                    .select('id, concepto, monto')
                    .eq('nombre_beneficiario', beneficiario)
                    .eq('fecha', fecha.split('T')[0]) // Solo la fecha, sin hora
                    .or(palabrasComida.map(palabra => `concepto.ilike.%${palabra}%`).join(','));
                
                if (error) {
                    console.error('Error validando comida:', error);
                    return { valido: false, mensaje: 'Error al validar. Intente nuevamente.' };
                }
                
                if (data && data.length > 0) {
                    const reembolsoExistente = data[0];
                    return { 
                        valido: false, 
                        mensaje: `❌ ${beneficiario} ya tiene un reembolso de comida registrado para el ${new Date(fecha).toLocaleDateString('es-MX')}.\n\nConcepto existente: "${reembolsoExistente.concepto}"\nMonto: $${parseFloat(reembolsoExistente.monto).toLocaleString()}\n\n⚠️ Solo se permite un concepto de comida por beneficiario por día.` 
                    };
                }
                
                return { valido: true };
                
            } catch (error) {
                console.error('Error en validación de comida:', error);
                return { valido: false, mensaje: 'Error al validar. Intente nuevamente.' };
            }
        }





    // ===================================================================
    // EXPONER FUNCIONES AL SCOPE GLOBAL PARA onclick EN HTML
    // ===================================================================
    // Esto permite que los botones HTML con onclick="" puedan llamar a estas funciones
    // mientras mantenemos el IIFE para prevenir ejecución duplicada del script

    window.logout = logout;
    window.showTab = showTab;
    window.registrarReembolso = registrarReembolso;
    window.verDetalles = verDetalles;
    window.cerrarModal = cerrarModal;
    window.recargarDatosCompletos = recargarDatosCompletos;
    window.descargarPlantillaExcel = descargarPlantillaExcel;
    window.generarReporte = generarReporte;
    window.exportarExcel = exportarExcel;
    window.procesarReembolsosMasivos = procesarReembolsosMasivos;
    window.solicitarEntregaLoteEspecifico = solicitarEntregaLoteEspecifico;
    window.toggleLoteDetalle = toggleLoteDetalle;
    window.toggleLoteDetalleSolicitud = toggleLoteDetalleSolicitud;
    window.subirEvidenciaEntregaLote = subirEvidenciaEntregaLote;
    window.enviarSolicitudAutorizacion = enviarSolicitudAutorizacion;
    window.mostrarVistaTabla = mostrarVistaTabla;
    window.mostrarVistaLotes = mostrarVistaLotes;
    window.verArchivosReembolso = verArchivosReembolso;
    window.toggleDetalleLote = toggleDetalleLote;
    window.sanitizarIdLote = sanitizarIdLote;
    window.toggleLote = toggleLote;
    window.editarReembolso = editarReembolso;
    window.guardarEdicion = guardarEdicion;

    })(); // Fin del IIFE - Prevención de ejecución múltiple
    </script>
    </body>
 </html> 
